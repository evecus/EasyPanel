<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
<title>EasyPanel</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --h1:#a855f7;--h2:#ec4899;
  --grad:linear-gradient(135deg,var(--h1),var(--h2));
  --grad-soft:linear-gradient(135deg,color-mix(in srgb,var(--h1) 15%,white),color-mix(in srgb,var(--h2) 15%,white));
  --accent:var(--h1);--accent2:var(--h2);
  --text:#1e1b2e;--sub:#6b7280;--border:#ede8f5;--bg:#faf8ff;
  --card:rgba(255,255,255,.85);
  --tr:.2s cubic-bezier(.4,0,.2,1);
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Microsoft YaHei',sans-serif;min-height:100vh;overflow-x:hidden;-webkit-tap-highlight-color:transparent;background:var(--bg)}

.glass{background:rgba(255,255,255,.72);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid rgba(255,255,255,.55)}
.grad-text{background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

/* LOGIN */
#login-overlay{position:fixed;inset:0;z-index:800;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.38);backdrop-filter:blur(12px)}
#login-overlay.hidden{display:none}
.login-card{background:rgba(255,255,255,.9);backdrop-filter:blur(30px);border-radius:24px;padding:38px 42px 30px;width:380px;max-width:92vw;box-shadow:0 32px 80px rgba(168,85,247,.18),0 2px 0 rgba(255,255,255,.8) inset;border:1px solid rgba(255,255,255,.7);animation:pop-in .24s ease}
@keyframes pop-in{from{transform:scale(.93) translateY(12px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.login-logo-wrap{width:48px;height:48px;background:var(--grad);border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:18px;box-shadow:0 6px 20px color-mix(in srgb,var(--h1) 40%,transparent)}
.login-title{font-size:26px;font-weight:800;text-align:center;margin-bottom:4px}
.login-title span{background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.login-sub{font-size:13px;color:#94a3b8;text-align:center;margin-bottom:24px}
.fg{position:relative;margin-bottom:12px}
.fg input{width:100%;padding:13px 14px 13px 42px;border:1.5px solid #ede8f5;border-radius:13px;font-size:15px;background:rgba(250,248,255,.8);outline:none;color:#1e1b2e;transition:all var(--tr);font-family:inherit}
.fg input:focus{border-color:var(--h1);background:white;box-shadow:0 0 0 3px color-mix(in srgb,var(--h1) 12%,transparent)}
.fg .fi{position:absolute;left:13px;top:50%;transform:translateY(-50%);font-size:16px}
.login-btn{width:100%;padding:14px;background:var(--grad);border:none;border-radius:13px;font-size:15px;font-weight:700;cursor:pointer;color:white;box-shadow:0 6px 20px color-mix(in srgb,var(--h1) 35%,transparent);transition:all var(--tr);margin-top:4px}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px color-mix(in srgb,var(--h1) 45%,transparent)}
.login-btn:active{transform:translateY(0)}
.login-err{color:#ef4444;font-size:13px;text-align:center;margin-top:8px;display:none}
.login-foot{text-align:center;margin-top:18px;font-size:12px;color:#94a3b8}

/* DASHBOARD */
#dashboard{min-height:100vh;position:relative}
.wp-bg{position:fixed;inset:0;z-index:0;background-size:cover;background-position:center;transition:background .6s}
.wp-overlay{position:fixed;inset:0;z-index:0;background:rgba(0,0,0,.22)}
.dash-content{position:relative;z-index:1;min-height:100vh;display:flex;flex-direction:column}

/* Header: logo left, settings right */
.dash-header{display:flex;justify-content:space-between;align-items:flex-start;padding:22px 52px 0}
.dash-logo{height:34px;width:auto;border-radius:8px;object-fit:contain;display:none}
.icon-btn{width:40px;height:40px;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:white;font-size:17px;transition:all var(--tr);border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.15);backdrop-filter:blur(12px)}
.icon-btn:hover{background:rgba(255,255,255,.28);transform:translateY(-1px)}

/* Hero */
.hero{text-align:center;padding:32px 20px 40px;color:white;flex-shrink:0}
.hero-hostname{font-size:56px;font-weight:900;letter-spacing:-1.5px;line-height:1.05;margin-bottom:10px;text-shadow:0 2px 24px rgba(0,0,0,.28)}
.hero-clock{font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;opacity:.9}
.hero-clock .div{opacity:.35}

/* Apps */
.apps-outer{flex:1;padding:0 52px 52px;display:flex;justify-content:center}
.apps-inner{width:100%;max-width:1100px}
.group-row{display:flex;align-items:center;gap:10px;margin-bottom:18px}
.group-lbl{color:rgba(255,255,255,.92);font-size:15px;font-weight:800;text-transform:uppercase;letter-spacing:2px;text-shadow:0 1px 6px rgba(0,0,0,.3)}
.group-tools{display:none;align-items:center;gap:6px}
.group-row:hover .group-tools{display:flex}
.tool-btn{width:30px;height:30px;border-radius:9px;border:1.5px solid rgba(255,255,255,.4);background:rgba(255,255,255,.12);backdrop-filter:blur(8px);cursor:pointer;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.9);transition:all var(--tr)}
.tool-btn:hover,.tool-btn.active{background:rgba(255,255,255,.28);border-color:white}
#sort-bar{display:none;margin-bottom:14px;gap:8px;flex-wrap:wrap}
.sort-btn{padding:8px 18px;background:rgba(255,255,255,.88);color:#1e1b2e;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:5px;box-shadow:0 4px 14px rgba(0,0,0,.14);transition:all var(--tr)}
.sort-btn:hover{background:white;transform:translateY(-1px)}
.apps-grid{display:flex;flex-wrap:wrap;gap:22px;justify-content:flex-start}

/* App card */
.app-card{display:flex;flex-direction:column;align-items:center;gap:9px;cursor:pointer;width:92px;user-select:none;-webkit-user-select:none}
.app-icon-wrap{width:78px;height:78px;border-radius:20px;overflow:hidden;transition:transform var(--tr),box-shadow var(--tr);box-shadow:0 6px 20px rgba(0,0,0,.24),0 1px 0 rgba(255,255,255,.2) inset}
.app-card:not(.sort-mode):hover .app-icon-wrap{transform:translateY(-6px) scale(1.07);box-shadow:0 16px 36px rgba(0,0,0,.32),0 1px 0 rgba(255,255,255,.2) inset}
.app-icon-img{width:100%;height:100%;object-fit:cover;border-radius:20px;display:block}
.app-icon-txt{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--grad);font-size:26px;font-weight:800;color:white;text-shadow:0 1px 4px rgba(0,0,0,.25);border-radius:20px}
.app-name{font-size:12px;color:rgba(255,255,255,.96);text-align:center;font-weight:600;text-shadow:0 1px 4px rgba(0,0,0,.4);max-width:88px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.app-card.sort-mode{animation:wiggle .4s ease infinite alternate}
@keyframes wiggle{from{transform:rotate(-1.5deg) scale(.97)}to{transform:rotate(1.5deg) scale(.97)}}
.app-card.sort-mode .app-icon-wrap{border:2.5px dashed rgba(255,255,255,.65);transform:none!important;box-shadow:none!important}
.app-card.drag-over .app-icon-wrap{border-color:white;background:rgba(255,255,255,.12)}

/* CONTEXT MENU */
.ctx{position:fixed;z-index:9999;background:rgba(255,255,255,.97);backdrop-filter:blur(20px);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.18),0 1px 0 rgba(255,255,255,.8) inset;padding:5px;min-width:140px;display:none;border:1px solid rgba(255,255,255,.6);animation:pop-in .14s ease}
.ctx.show{display:block}
.ctx-item{display:flex;align-items:center;gap:9px;padding:10px 14px;border-radius:9px;cursor:pointer;font-size:14px;font-weight:500;color:#1e1b2e;transition:background var(--tr);user-select:none}
.ctx-item:hover{background:rgba(168,85,247,.08)}
.ctx-item.danger{color:#ef4444}.ctx-item.danger:hover{background:#fef2f2}

/* APP MODAL */
.modal-overlay{position:fixed;inset:0;z-index:700;background:rgba(0,0,0,.4);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;padding:16px}
.modal-overlay.show{display:flex}
.modal{background:white;border-radius:22px;padding:28px;width:460px;max-width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(168,85,247,.18);animation:pop-in .2s ease;border:1px solid rgba(168,85,247,.1)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px}
.modal-title{font-size:17px;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.close-btn{width:32px;height:32px;border:none;background:#f5f3ff;border-radius:9px;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;color:#64748b;transition:all var(--tr)}
.close-btn:hover{background:#ede9fe}
.preview-box{background:linear-gradient(135deg,#faf5ff,#fdf2f8);border-radius:14px;padding:14px;margin-bottom:20px;display:flex;align-items:center;gap:14px;border:1px solid rgba(168,85,247,.1)}
.preview-ico{width:52px;height:52px;border-radius:14px;overflow:hidden;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:white;flex-shrink:0}
.preview-ico img{width:100%;height:100%;object-fit:cover}
.preview-t{font-size:14px;font-weight:700;color:#1e1b2e}
.preview-u{font-size:12px;color:#94a3b8;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:260px}
.fl{display:block;font-size:11px;font-weight:700;color:#94a3b8;margin-bottom:5px;text-transform:uppercase;letter-spacing:.6px}
.fi2{width:100%;padding:11px 13px;border:1.5px solid #ede8f5;border-radius:11px;font-size:14px;color:#1e1b2e;outline:none;transition:all var(--tr);background:#faf8ff;font-family:inherit}
.fi2:focus{border-color:var(--h1);background:white;box-shadow:0 0 0 3px color-mix(in srgb,var(--h1) 10%,transparent)}
.fr{margin-bottom:14px}
.itabs{display:flex;gap:3px;background:#f5f3ff;border-radius:11px;padding:3px;margin-bottom:10px}
.itab{flex:1;padding:8px;border:none;background:transparent;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;color:#94a3b8;transition:all var(--tr)}
.itab.active{background:white;color:var(--h1);box-shadow:0 2px 8px rgba(168,85,247,.15)}
.img-row{display:flex;gap:7px;align-items:center}
.img-row .fi2{flex:1}
.upbtn{padding:11px 13px;border:1.5px solid #ede8f5;border-radius:11px;background:white;cursor:pointer;font-size:13px;font-weight:600;color:#94a3b8;white-space:nowrap;transition:all var(--tr);display:flex;align-items:center;gap:5px}
.upbtn:hover{border-color:var(--h1);color:var(--h1)}
.mfooter{display:flex;justify-content:flex-end;gap:8px;margin-top:20px;padding-top:16px;border-top:1px solid #f5f3ff}
.btn{padding:10px 20px;border-radius:11px;font-size:14px;font-weight:700;cursor:pointer;border:none;transition:all var(--tr)}
.btn-s{background:#f5f3ff;color:#94a3b8}.btn-s:hover{background:#ede9fe;color:#7c3aed}
.btn-p{background:var(--grad);color:white;box-shadow:0 4px 14px color-mix(in srgb,var(--h1) 30%,transparent)}.btn-p:hover{transform:translateY(-1px);box-shadow:0 8px 20px color-mix(in srgb,var(--h1) 40%,transparent)}
.btn-d{background:#fef2f2;color:#ef4444}.btn-d:hover{background:#fee2e2}

/* SETTINGS */
.s-backdrop{position:fixed;inset:0;z-index:750;background:rgba(0,0,0,.28);display:none}
.s-backdrop.show{display:block}
.s-panel{position:fixed;inset:0;z-index:760;display:none;align-items:center;justify-content:center;padding:20px}
.s-panel.open{display:flex}
.s-box{background:white;border-radius:22px;width:min(940px,100%);height:min(690px,90vh);display:flex;overflow:hidden;box-shadow:0 32px 80px rgba(168,85,247,.2)}
.s-nav{width:215px;flex-shrink:0;background:linear-gradient(180deg,#faf5ff 0%,#fdf2f8 100%);border-right:1px solid #ede8f5;display:flex;flex-direction:column;overflow-y:auto;position:relative}
/* Red X button in top-left corner of nav */
.s-close-top{position:absolute;top:12px;left:12px;width:20px;height:20px;border-radius:50%;background:#ff5f57;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:rgba(0,0,0,0);font-size:10px;font-weight:700;transition:all var(--tr);box-shadow:0 2px 5px rgba(255,95,87,.35);z-index:1}
.s-close-top:hover{color:rgba(0,0,0,.5)}
.s-close-top::after{content:'âœ•';position:absolute;opacity:0;transition:opacity var(--tr)}
.s-close-top:hover::after{opacity:1}
.s-nav-header{padding:20px 18px 14px 42px;display:flex;align-items:center;gap:10px}
.s-nav-ico{width:32px;height:32px;background:var(--grad);border-radius:9px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 4px 12px color-mix(in srgb,var(--h1) 35%,transparent)}
.s-nav-t{font-size:14px;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.s-nav-list{padding:8px;flex:1}
.s-ni{display:flex;align-items:center;gap:9px;padding:10px 13px;border-radius:11px;cursor:pointer;font-size:13px;font-weight:600;color:#6b7280;transition:all var(--tr);margin-bottom:3px}
.s-ni:hover{background:rgba(168,85,247,.07);color:#1e1b2e}
.s-ni.active{background:var(--grad);color:white;box-shadow:0 4px 14px color-mix(in srgb,var(--h1) 30%,transparent)}
.s-ni .s-ico{font-size:16px;width:22px;text-align:center}
.s-content{flex:1;overflow-y:auto;padding:28px 30px}
.s-sec{display:none}
.s-sec.active{display:block}
.s-title{font-size:17px;font-weight:800;color:#1e1b2e;margin-bottom:20px;padding-bottom:13px;border-bottom:2px solid #f5f3ff;display:flex;align-items:center;gap:8px}
.s-card{background:#faf8ff;border-radius:14px;padding:18px;margin-bottom:14px;border:1px solid #ede8f5}
.s-row{margin-bottom:14px}
.s-row:last-child{margin-bottom:0}
.s-lbl{display:block;font-size:11px;font-weight:700;color:#94a3b8;margin-bottom:5px;text-transform:uppercase;letter-spacing:.6px}
.s-inp{width:100%;padding:10px 13px;border:1.5px solid #ede8f5;border-radius:11px;font-size:14px;color:#1e1b2e;outline:none;transition:all var(--tr);background:white;font-family:inherit}
.s-inp:focus{border-color:var(--h1);box-shadow:0 0 0 3px color-mix(in srgb,var(--h1) 10%,transparent)}
.s-inp:disabled{background:#f5f3ff;color:#94a3b8}

/* Sliders */
.s-slider-row{display:flex;align-items:center;gap:12px}
.s-slider{flex:1;-webkit-appearance:none;appearance:none;height:6px;border-radius:3px;background:#ede8f5;outline:none;cursor:pointer}
.s-slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--grad);cursor:pointer;box-shadow:0 2px 6px rgba(168,85,247,.3)}
.s-slider::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--h1);cursor:pointer;border:none}
.s-slider-val{width:44px;text-align:right;font-size:13px;font-weight:700;color:var(--h1)}

/* Toggle */
.t-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid #f5f3ff}
.t-row:last-child{border-bottom:none}
.t-lbl{font-size:14px;font-weight:600;color:#1e1b2e}
.t-sub{font-size:12px;color:#94a3b8;margin-top:2px}
.sw{position:relative;width:42px;height:24px;flex-shrink:0}
.sw input{opacity:0;width:0;height:0}
.sl{position:absolute;inset:0;background:#e2e8f0;border-radius:24px;cursor:pointer;transition:all var(--tr)}
.sl:before{content:'';position:absolute;width:18px;height:18px;background:white;border-radius:50%;left:3px;top:3px;transition:transform var(--tr);box-shadow:0 1px 4px rgba(0,0,0,.2)}
.sw input:checked+.sl{background:var(--grad)}
.sw input:checked+.sl:before{transform:translateX(18px)}

/* Language */
.lang-btns{display:flex;gap:8px}
.lang-btn{flex:1;padding:9px 14px;border:2px solid #ede8f5;border-radius:11px;background:white;cursor:pointer;font-size:14px;font-weight:700;color:#6b7280;transition:all var(--tr);text-align:center}
.lang-btn:hover{border-color:var(--h1);color:var(--h1)}
.lang-btn.active{border-color:var(--h1);color:var(--h1);background:#faf5ff;box-shadow:0 2px 8px color-mix(in srgb,var(--h1) 15%,transparent)}

/* Theme */
.theme-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:4px}
.theme-item{border-radius:13px;padding:12px 8px;cursor:pointer;transition:all var(--tr);background:white;border:2px solid #ede8f5;text-align:center}
.theme-item:hover{transform:scale(1.04);border-color:var(--h1)}
.theme-item.sel{border-color:var(--h1);box-shadow:0 4px 14px color-mix(in srgb,var(--h1) 25%,transparent)}
.theme-dot{width:36px;height:36px;border-radius:50%;margin:0 auto 8px;box-shadow:0 3px 10px rgba(0,0,0,.15)}
.theme-name{font-size:11px;font-weight:600;color:#4b5563}

/* Users */
.u-table{width:100%;border-collapse:collapse}
.u-table th{font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;padding:8px 13px;text-align:left;background:#f5f3ff;border-bottom:1px solid #ede8f5}
.u-table th:first-child{border-radius:10px 0 0 0}.u-table th:last-child{border-radius:0 10px 0 0}
.u-table td{padding:12px 13px;border-bottom:1px solid #faf5ff;font-size:14px;color:#1e1b2e}
.u-table tr:last-child td{border-bottom:none}
.badge{display:inline-flex;padding:3px 9px;border-radius:7px;font-size:11px;font-weight:700}
.b-admin{background:#fef3c7;color:#d97706}
.b-user{background:#f0fdf4;color:#16a34a}
.b-cur{background:#ede9fe;color:#7c3aed;margin-left:4px;font-size:10px}

/* Wallpaper */
.wp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-bottom:14px}
.wp-thumb{aspect-ratio:16/9;border-radius:11px;cursor:pointer;overflow:hidden;border:3px solid transparent;transition:all var(--tr);position:relative}
.wp-thumb:hover,.wp-thumb.sel{border-color:var(--h1);transform:scale(1.03);box-shadow:0 4px 14px color-mix(in srgb,var(--h1) 25%,transparent)}
.wp-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.info-box{background:linear-gradient(135deg,#f5f3ff,#fdf2f8);border:1px solid rgba(168,85,247,.15);border-radius:11px;padding:13px 15px;font-size:13px;color:#7c3aed;margin-bottom:16px;line-height:1.6}
.backup-btns{display:flex;gap:10px;flex-wrap:wrap}
.backup-btn{flex:1;min-width:140px;padding:13px;border-radius:12px;border:2px dashed #d8b4fe;background:#faf5ff;cursor:pointer;font-size:14px;font-weight:600;color:#7c3aed;transition:all var(--tr);display:flex;flex-direction:column;align-items:center;gap:6px}
.backup-btn:hover{background:#f3e8ff;border-color:var(--h1);transform:translateY(-2px)}
.backup-btn .b-ico{font-size:24px}
.backup-btn .b-sub{font-size:11px;color:#94a3b8;font-weight:500}
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(120px);background:rgba(15,5,30,.82);color:white;padding:10px 22px;border-radius:24px;font-size:13px;z-index:9999;transition:transform .26s;backdrop-filter:blur(12px);white-space:nowrap;pointer-events:none;box-shadow:0 8px 24px rgba(0,0,0,.2)}
.toast.show{transform:translateX(-50%) translateY(0)}

@media(max-width:700px){
  .dash-header{padding:14px 18px 0}
  .hero{padding:22px 16px 30px}
  .apps-outer{padding:0 18px 28px}
  .apps-grid{gap:14px;justify-content:center}
  .s-panel{padding:0}
  .s-box{width:100%;height:100%;border-radius:0;flex-direction:column}
  .s-nav{width:100%;height:auto;border-right:none;border-bottom:1px solid #ede8f5;flex-shrink:0}
  .s-nav-list{display:flex;flex-direction:row;flex-wrap:wrap;gap:3px;padding:6px 10px 10px}
  .s-ni{padding:7px 10px;margin-bottom:0;font-size:12px}
  .s-nav-header{padding:12px 14px 6px 40px}
  .s-content{padding:16px 14px}
  .wp-grid{grid-template-columns:repeat(2,1fr)}
  .theme-grid{grid-template-columns:repeat(3,1fr)}
  .backup-btns{flex-direction:column}
}
</style>
</head>
<body>

<div id="dashboard">
  <div class="wp-bg" id="wp-bg"></div>
  <div class="wp-overlay"></div>
  <div class="dash-content">
    <div class="dash-header">
      <img class="dash-logo" id="dash-logo" src="" alt="">
      <!-- Settings icon is now in the RIGHT corner -->
      <button class="icon-btn" id="btn-settings">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06-.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
    </div>
    <div class="hero">
      <div class="hero-hostname" id="hero-hostname">EasyPanel</div>
      <div class="hero-clock" id="hero-clock"></div>
    </div>
    <div class="apps-outer">
      <div class="apps-inner" id="apps-inner"></div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div id="login-overlay" class="hidden">
  <div class="login-card">
    <div class="login-logo-wrap"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/></svg></div>
    <div class="login-title"><span>EasyPanel</span></div>
    <div class="login-sub" id="login-sub">è¯·ç™»å½•ä»¥ç»§ç»­</div>
    <div class="fg"><span class="fi">ğŸ‘¤</span><input type="text" id="lu" placeholder="è´¦å·" autocomplete="username"></div>
    <div class="fg"><span class="fi">ğŸ”’</span><input type="password" id="lp" placeholder="å¯†ç " autocomplete="current-password"></div>
    <p class="login-err" id="lerr">è´¦å·æˆ–å¯†ç é”™è¯¯</p>
    <button class="login-btn" id="login-btn-el" onclick="doLogin()">ç™»å½•</button>
    <p class="login-foot">Powered By EasyPanel</p>
  </div>
</div>

<!-- APP MODAL -->
<div class="modal-overlay" id="app-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">æ·»åŠ åº”ç”¨</div>
      <button class="close-btn" onclick="closeModal()">âœ•</button>
    </div>
    <div class="preview-box">
      <div class="preview-ico" id="prev-ico">A</div>
      <div><div class="preview-t" id="prev-t">åº”ç”¨åç§°</div><div class="preview-u" id="prev-u">https://...</div></div>
    </div>
    <div class="fr"><label class="fl" id="lbl-icon-style">å›¾æ ‡é£æ ¼</label>
      <div class="itabs">
        <button class="itab active" id="itab-text" onclick="setIT('text')">æ–‡å­—</button>
        <button class="itab" id="itab-image" onclick="setIT('image')">å›¾ç‰‡</button>
      </div>
      <div id="it-text"><input type="text" class="fi2" id="icon-txt" placeholder="æ–‡å­—ï¼ˆæœ€å¤š2å­—ç¬¦ï¼‰" maxlength="2" oninput="updPrev()"></div>
      <!-- Image tab: supports BOTH URL input and file upload -->
      <div id="it-img" style="display:none">
        <div class="img-row">
          <input type="text" class="fi2" id="icon-url" placeholder="è¾“å…¥å›¾æ ‡åœ°å€æˆ–ç‚¹å³ä¾§ä¸Šä¼ " oninput="updPrev()">
          <label class="upbtn" for="icon-file" title="ä¸Šä¼ å›¾ç‰‡">ğŸ“</label>
          <input type="file" id="icon-file" accept="image/*" style="display:none" onchange="uploadIcon(this)">
        </div>
      </div>
    </div>
    <div class="fr"><label class="fl" id="lbl-title">æ ‡é¢˜ *</label><input type="text" class="fi2" id="app-title" placeholder="è¯·è¾“å…¥" maxlength="20" oninput="updPrev()"></div>
    <div class="fr"><label class="fl" id="lbl-url">åœ°å€ *</label><input type="text" class="fi2" id="app-url" placeholder="http(s)://"></div>
    <div class="fr"><label class="fl" id="lbl-open">æ‰“å¼€æ–¹å¼</label>
      <select class="fi2" id="app-open">
        <option value="new_tab" id="opt-newtab">æ–°çª—å£æ‰“å¼€</option>
        <option value="current" id="opt-current">å½“å‰çª—å£</option>
      </select>
    </div>
    <div class="mfooter">
      <button class="btn btn-d" id="modal-del" onclick="delApp()" style="display:none" id="btn-del-app">åˆ é™¤</button>
      <button class="btn btn-s" onclick="closeModal()" id="btn-cancel-modal">å–æ¶ˆ</button>
      <button class="btn btn-p" onclick="saveApp()" id="btn-save-app">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- CONTEXT MENU (single instance, no duplicate) -->
<div class="ctx" id="ctx">
  <div class="ctx-item" id="ctx-edit-item">âœï¸ &nbsp;<span id="ctx-edit-label">ç¼–è¾‘</span></div>
  <div class="ctx-item danger" id="ctx-del-item">ğŸ—‘ &nbsp;<span id="ctx-del-label">åˆ é™¤</span></div>
</div>

<!-- SETTINGS -->
<div class="s-backdrop" id="s-backdrop" onclick="closeSettings()"></div>
<div class="s-panel" id="s-panel">
  <div class="s-box">
    <div class="s-nav">
      <!-- Red X close button in top-left of settings panel -->
      <button class="s-close-top" id="s-close-top" onclick="closeSettings()" title="å…³é—­"></button>
      <div class="s-nav-header">
        <div class="s-nav-ico"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/></svg></div>
        <span class="s-nav-t" id="s-nav-title">ç³»ç»Ÿè®¾ç½®</span>
      </div>
      <div class="s-nav-list" id="s-nav-list">
        <div class="s-ni active" onclick="sTab('account')"><span class="s-ico">ğŸ‘¤</span><span id="ni-account">æˆ‘çš„ä¿¡æ¯</span></div>
        <div class="s-ni" onclick="sTab('panel')"><span class="s-ico">ğŸ¨</span><span id="ni-panel">ä¸ªæ€§åŒ–</span></div>
        <div class="s-ni" onclick="sTab('display')"><span class="s-ico">ğŸ“</span><span id="ni-display">æ˜¾ç¤ºå¤§å°</span></div>
        <div class="s-ni" onclick="sTab('theme')"><span class="s-ico">ğŸŒˆ</span><span id="ni-theme">ä¸»é¢˜è‰²</span></div>
        <div class="s-ni" onclick="sTab('clock')"><span class="s-ico">ğŸ•</span><span id="ni-clock">æ—¶é’Ÿç»„ä»¶</span></div>
        <div class="s-ni" onclick="sTab('wallpaper')"><span class="s-ico">ğŸ–¼ï¸</span><span id="ni-wallpaper">å£çº¸è®¾ç½®</span></div>
        <div class="s-ni" onclick="sTab('users')"><span class="s-ico">ğŸ‘¥</span><span id="ni-users">è´¦å·ç®¡ç†</span></div>
        <div class="s-ni" onclick="sTab('access')"><span class="s-ico">ğŸ”“</span><span id="ni-access">è®¿é—®æ§åˆ¶</span></div>
        <div class="s-ni" onclick="sTab('backup')"><span class="s-ico">ğŸ’¾</span><span id="ni-backup">æ•°æ®ç®¡ç†</span></div>
        <div class="s-ni" onclick="sTab('language')"><span class="s-ico">ğŸŒ</span><span id="ni-language">è¯­è¨€</span></div>
      </div>
    </div>

    <div class="s-content">

      <!-- æˆ‘çš„ä¿¡æ¯ -->
      <div class="s-sec active" id="st-account">
        <div class="s-title" id="title-account">ğŸ‘¤ æˆ‘çš„ä¿¡æ¯</div>
        <div class="s-card">
          <div class="s-row"><label class="s-lbl" id="lbl-username">è´¦å·</label><input class="s-inp" id="s-uname" disabled></div>
          <div class="s-row"><label class="s-lbl" id="lbl-nickname">æ˜µç§°</label><input class="s-inp" id="s-nick" placeholder="è¾“å…¥æ˜µç§°"></div>
          <button class="btn btn-p" onclick="saveNick()" id="btn-save-nick">ä¿å­˜æ˜µç§°</button>
        </div>
        <div class="s-card">
          <div class="s-title" style="font-size:14px;margin-bottom:14px;padding-bottom:10px;border-bottom-width:1px" id="title-change-pwd">ä¿®æ”¹å¯†ç </div>
          <div class="s-row"><label class="s-lbl" id="lbl-old-pwd">æ—§å¯†ç </label><input type="password" class="s-inp" id="s-opwd"></div>
          <div class="s-row"><label class="s-lbl" id="lbl-new-pwd">æ–°å¯†ç </label><input type="password" class="s-inp" id="s-npwd"></div>
          <button class="btn btn-p" onclick="changePwd()" id="btn-change-pwd">ä¿®æ”¹å¯†ç </button>
        </div>
        <button class="btn btn-d" style="width:100%;margin-top:6px" onclick="doLogout()" id="btn-logout">é€€å‡ºç™»å½•</button>
      </div>

      <!-- ä¸ªæ€§åŒ– -->
      <div class="s-sec" id="st-panel">
        <div class="s-title" id="title-panel">ğŸ¨ ä¸ªæ€§åŒ–è®¾ç½®</div>
        <div class="s-card">
          <div class="s-row"><label class="s-lbl" id="lbl-hostname-display">ä¸»æœºåæ˜¾ç¤º</label><input class="s-inp" id="s-host" placeholder="EasyPanel"></div>
          <div class="s-row"><label class="s-lbl">LOGO</label>
            <div class="img-row" style="margin-bottom:8px"><input class="s-inp" id="s-logo" placeholder="https://..." oninput="prvLogo()" style="flex:1"><label class="upbtn" for="logo-file">ğŸ“</label><input type="file" id="logo-file" accept="image/*" style="display:none" onchange="uploadLogo(this)"></div>
            <img id="logo-prv" style="width:48px;height:48px;border-radius:10px;object-fit:cover;display:none">
          </div>
          <button class="btn btn-p" onclick="savePanelCfg()" id="btn-save-panel">ä¿å­˜</button>
        </div>
      </div>

      <!-- æ˜¾ç¤ºå¤§å° (NEW) -->
      <div class="s-sec" id="st-display">
        <div class="s-title" id="title-display">ğŸ“ æ˜¾ç¤ºå¤§å°</div>
        <div class="s-card">
          <div class="s-row">
            <label class="s-lbl" id="lbl-hostname-size">ä¸»æœºåå¤§å°</label>
            <div class="s-slider-row">
              <input type="range" class="s-slider" id="sl-hostname" min="24" max="96" value="56" oninput="updSlider('hostname')">
              <span class="s-slider-val" id="sv-hostname">56px</span>
            </div>
          </div>
          <div class="s-row">
            <label class="s-lbl" id="lbl-clock-size">æ—¶é—´å­—ä½“å¤§å°</label>
            <div class="s-slider-row">
              <input type="range" class="s-slider" id="sl-clock" min="10" max="36" value="16" oninput="updSlider('clock')">
              <span class="s-slider-val" id="sv-clock">16px</span>
            </div>
          </div>
          <div class="s-row">
            <label class="s-lbl" id="lbl-icon-size">åº”ç”¨å›¾æ ‡å¤§å°</label>
            <div class="s-slider-row">
              <input type="range" class="s-slider" id="sl-icon" min="40" max="130" value="78" oninput="updSlider('icon')">
              <span class="s-slider-val" id="sv-icon">78px</span>
            </div>
          </div>
          <div class="s-row">
            <label class="s-lbl" id="lbl-appname-size">åº”ç”¨åç§°å¤§å°</label>
            <div class="s-slider-row">
              <input type="range" class="s-slider" id="sl-appname" min="8" max="22" value="12" oninput="updSlider('appname')">
              <span class="s-slider-val" id="sv-appname">12px</span>
            </div>
          </div>
          <button class="btn btn-p" onclick="saveDisplaySettings()" id="btn-save-display">ä¿å­˜</button>
        </div>
      </div>

      <!-- ä¸»é¢˜è‰² -->
      <div class="s-sec" id="st-theme">
        <div class="s-title" id="title-theme">ğŸŒˆ ä¸»é¢˜è‰²</div>
        <div class="s-card"><div class="theme-grid" id="theme-grid"></div></div>
      </div>

      <!-- æ—¶é’Ÿ -->
      <div class="s-sec" id="st-clock">
        <div class="s-title" id="title-clock">ğŸ• æ—¶é’Ÿç»„ä»¶</div>
        <div class="s-card">
          <div class="t-row"><div><div class="t-lbl" id="ck-lbl-time">æ˜¾ç¤ºæ—¶é—´</div></div><label class="sw"><input type="checkbox" id="ck-time" onchange="saveClk()"><span class="sl"></span></label></div>
          <div class="t-row"><div><div class="t-lbl" id="ck-lbl-sec">æ˜¾ç¤ºç§’</div></div><label class="sw"><input type="checkbox" id="ck-sec" onchange="saveClk()"><span class="sl"></span></label></div>
          <div class="t-row"><div><div class="t-lbl" id="ck-lbl-date">æ˜¾ç¤ºæ—¥æœŸ</div><div class="t-sub" id="ck-sub-date">æœˆ-æ—¥</div></div><label class="sw"><input type="checkbox" id="ck-date" onchange="saveClk()"><span class="sl"></span></label></div>
          <div class="t-row"><div><div class="t-lbl" id="ck-lbl-week">æ˜¾ç¤ºæ˜ŸæœŸ</div></div><label class="sw"><input type="checkbox" id="ck-week" onchange="saveClk()"><span class="sl"></span></label></div>
          <div class="t-row"><div><div class="t-lbl" id="ck-lbl-lunar">æ˜¾ç¤ºå†œå†</div><div class="t-sub" id="ck-sub-lunar">å¦‚ï¼šæ­£æœˆåˆä¸€</div></div><label class="sw"><input type="checkbox" id="ck-lunar" onchange="saveClk()"><span class="sl"></span></label></div>
        </div>
      </div>

      <!-- å£çº¸ -->
      <div class="s-sec" id="st-wallpaper">
        <div class="s-title" id="title-wallpaper">ğŸ–¼ï¸ å£çº¸è®¾ç½®</div>
        <div class="wp-grid" id="wp-grid"></div>
        <div class="s-row"><label class="s-lbl" id="lbl-custom-url">è‡ªå®šä¹‰ URL</label>
          <div class="img-row"><input class="s-inp" id="wp-url" placeholder="https://..." oninput="prvWp(this.value)" style="flex:1"><label class="upbtn" for="wp-file">ğŸ“</label><input type="file" id="wp-file" accept="image/*" style="display:none" onchange="uploadWp(this)"></div>
        </div>
        <button class="btn btn-p" onclick="saveWp()" id="btn-apply-wp">åº”ç”¨å£çº¸</button>
      </div>

      <!-- è´¦å·ç®¡ç† -->
      <div class="s-sec" id="st-users">
        <div class="s-title" id="title-users">ğŸ‘¥ è´¦å·ç®¡ç†</div>
        <div class="info-box" id="info-accounts">ç®¡ç†é¢æ¿ç™»å½•è´¦å·ã€‚å„è´¦å·ç‹¬ç«‹ç®¡ç†æ•°æ®ã€‚</div>
        <div class="s-card" style="overflow-x:auto;padding:0"><table class="u-table" id="u-table"></table></div>
        <div class="s-card" style="margin-top:12px">
          <div class="s-title" style="font-size:14px;margin-bottom:12px;padding-bottom:10px;border-bottom-width:1px" id="title-add-user">æ·»åŠ ç”¨æˆ·</div>
          <div class="s-row"><label class="s-lbl" id="lbl-nu-name">è´¦å·</label><input class="s-inp" id="nu-name"></div>
          <div class="s-row"><label class="s-lbl" id="lbl-nu-pwd">å¯†ç </label><input type="password" class="s-inp" id="nu-pwd"></div>
          <div class="s-row"><label class="s-lbl" id="lbl-nu-nick">æ˜µç§°ï¼ˆå¯é€‰ï¼‰</label><input class="s-inp" id="nu-nick"></div>
          <button class="btn btn-p" onclick="addUser()" id="btn-add-user">æ·»åŠ </button>
        </div>
      </div>

      <!-- è®¿é—®æ§åˆ¶ -->
      <div class="s-sec" id="st-access">
        <div class="s-title" id="title-access">ğŸ”“ è®¿é—®æ§åˆ¶</div>
        <div class="s-card">
          <div class="t-row">
            <div><div class="t-lbl" id="lbl-pub-mode">å…¬å¼€è®¿é—®æ¨¡å¼</div><div class="t-sub" id="sub-pub-mode">æ— éœ€ç™»å½•å³å¯æµè§ˆï¼Œç¼–è¾‘æ“ä½œä»éœ€ç™»å½•</div></div>
            <label class="sw"><input type="checkbox" id="pub-toggle" onchange="setPubMode(this.checked)"><span class="sl"></span></label>
          </div>
        </div>
        <div class="info-box" style="margin-top:12px" id="info-access">
          <b id="lbl-private-mode">ç§æœ‰æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼š</b><span id="desc-private-mode">è®¿é—®é¢æ¿éœ€å…ˆç™»å½•</span><br>
          <b id="lbl-public-mode">å…¬å¼€æ¨¡å¼ï¼š</b><span id="desc-public-mode">ä»»ä½•äººå¯æµè§ˆé¢æ¿ï¼Œç‚¹å‡»è®¾ç½®/ç¼–è¾‘æ—¶å¼¹å‡ºç™»å½•æ¡†</span>
        </div>
      </div>

      <!-- æ•°æ®ç®¡ç† -->
      <div class="s-sec" id="st-backup">
        <div class="s-title" id="title-backup">ğŸ’¾ æ•°æ®ç®¡ç†</div>
        <div class="info-box" id="info-backup">å¤‡ä»½åŒ…å«ï¼šæ‰€æœ‰åº”ç”¨å›¾æ ‡ã€é¢æ¿è®¾ç½®ã€æ—¶é’Ÿé…ç½®ã€å£çº¸ä¿¡æ¯ã€‚<br>è´¦æˆ·å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ä¸å«åœ¨å¤‡ä»½ä¸­ã€‚</div>
        <div class="s-card">
          <div class="backup-btns">
            <button class="backup-btn" onclick="exportData()">
              <span class="b-ico">ğŸ“¤</span><span id="btn-export">å¯¼å‡ºæ•°æ®</span><span class="b-sub" id="desc-export">ä¸‹è½½ JSON å¤‡ä»½æ–‡ä»¶</span>
            </button>
            <label class="backup-btn" for="import-file">
              <span class="b-ico">ğŸ“¥</span><span id="btn-import">å¯¼å…¥æ•°æ®</span><span class="b-sub" id="desc-import">ä»å¤‡ä»½æ–‡ä»¶æ¢å¤</span>
            </label>
            <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(this)">
          </div>
        </div>
        <div class="s-card" style="margin-top:12px">
          <div class="t-lbl" style="margin-bottom:10px" id="lbl-danger">å±é™©æ“ä½œ</div>
          <button class="btn btn-d" onclick="clearAllData()" style="width:100%" id="btn-clear">ğŸ—‘ æ¸…ç©ºæ‰€æœ‰åº”ç”¨æ•°æ®</button>
        </div>
      </div>

      <!-- è¯­è¨€ / Language -->
      <div class="s-sec" id="st-language">
        <div class="s-title">ğŸŒ è¯­è¨€ / Language</div>
        <div class="s-card">
          <div class="s-row">
            <label class="s-lbl">è¯­è¨€ / Language</label>
            <div class="lang-btns">
              <button class="lang-btn active" id="lang-zh" onclick="setLang('zh')">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
              <button class="lang-btn" id="lang-en" onclick="setLang('en')">ğŸ‡¬ğŸ‡§ English</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ å†œå† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LD=[0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5b0,0x14573,0x052b0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b6a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06aa0,0x0a6b6,0x056a0,0x02b40,0x0d9e4,0x0d950,0x0c954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0f92f,0x0e950,0x06c40,0x0d9a6,0x0aad0,0x055b0,0x04ae4,0x0a570,0x05260,0x0f263,0x0d950];
const LM=['æ­£','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å','å†¬','è…Š'];
const LD2=['åˆä¸€','åˆäºŒ','åˆä¸‰','åˆå››','åˆäº”','åˆå…­','åˆä¸ƒ','åˆå…«','åˆä¹','åˆå','åä¸€','åäºŒ','åä¸‰','åå››','åäº”','åå…­','åä¸ƒ','åå…«','åä¹','äºŒå','å»¿ä¸€','å»¿äºŒ','å»¿ä¸‰','å»¿å››','å»¿äº”','å»¿å…­','å»¿ä¸ƒ','å»¿å…«','å»¿ä¹','ä¸‰å'];
function lMon(y){return LD[y-1900]&0xf}function lDays(y){return lMon(y)?((LD[y-1900]&0x10000)?30:29):0}function mDays(y,m){return(LD[y-1900]&(0x10000>>m))?30:29}function lyDays(y){let i,s=348;for(i=0x8000;i>0x8;i>>=1)s+=(LD[y-1900]&i)?1:0;return s+lDays(y)}
function getLunar(date){try{const base=new Date(1900,0,31);let off=Math.round((date-base)/86400000),y,temp=0;for(y=1900;y<2101&&temp<=off;y++)temp+=lyDays(y);if(temp>off)y--;off-=(temp-lyDays(y));let m,isL=false,lm=lMon(y);for(m=1;m<=12&&off>0;m++){let d;if(!isL&&m==lm+1&&lDays(y)>0){--m;isL=true;d=lDays(y);}else d=mDays(y,m);if(isL&&m==lm+1)isL=false;off-=d;}if(off==0&&lm==m-1&&lDays(y)>0){if(isL)isL=false;else{isL=true;--m;}}if(off<0){off+=mDays(y,m-1);--m;}return LM[m-1]+'æœˆ'+LD2[off];}catch(e){return '';}}

// â”€â”€ i18n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STRINGS = {
  zh: {
    loginSub:'è¯·ç™»å½•ä»¥ç»§ç»­',loginBtn:'ç™»å½•',loginErr:'è´¦å·æˆ–å¯†ç é”™è¯¯',
    addApp:'æ·»åŠ åº”ç”¨',editApp:'ç¼–è¾‘åº”ç”¨',appNamePrev:'åº”ç”¨åç§°',
    iconStyle:'å›¾æ ‡é£æ ¼',textIcon:'æ–‡å­—',imageIcon:'å›¾ç‰‡',
    iconPlaceholder:'æ–‡å­—ï¼ˆæœ€å¤š2å­—ç¬¦ï¼‰',iconUrlPlaceholder:'è¾“å…¥å›¾æ ‡åœ°å€æˆ–ç‚¹å³ä¾§ä¸Šä¼ ',
    titleLbl:'æ ‡é¢˜ *',urlLbl:'åœ°å€ *',openLbl:'æ‰“å¼€æ–¹å¼',
    newTab:'æ–°çª—å£æ‰“å¼€',currentTab:'å½“å‰çª—å£',
    deleteBtn:'åˆ é™¤',cancelBtn:'å–æ¶ˆ',saveBtn:'ä¿å­˜',editLabel:'ç¼–è¾‘',
    sysSettings:'ç³»ç»Ÿè®¾ç½®',
    niAccount:'æˆ‘çš„ä¿¡æ¯',niPanel:'ä¸ªæ€§åŒ–',niDisplay:'æ˜¾ç¤ºå¤§å°',niTheme:'ä¸»é¢˜è‰²',niClock:'æ—¶é’Ÿç»„ä»¶',niWallpaper:'å£çº¸è®¾ç½®',niUsers:'è´¦å·ç®¡ç†',niAccess:'è®¿é—®æ§åˆ¶',niBackup:'æ•°æ®ç®¡ç†',niLanguage:'è¯­è¨€',
    titleAccount:'ğŸ‘¤ æˆ‘çš„ä¿¡æ¯',titlePanel:'ğŸ¨ ä¸ªæ€§åŒ–è®¾ç½®',titleDisplay:'ğŸ“ æ˜¾ç¤ºå¤§å°',titleTheme:'ğŸŒˆ ä¸»é¢˜è‰²',titleClock:'ğŸ• æ—¶é’Ÿç»„ä»¶',titleWallpaper:'ğŸ–¼ï¸ å£çº¸è®¾ç½®',titleUsers:'ğŸ‘¥ è´¦å·ç®¡ç†',titleAccess:'ğŸ”“ è®¿é—®æ§åˆ¶',titleBackup:'ğŸ’¾ æ•°æ®ç®¡ç†',
    lblUsername:'è´¦å·',lblNickname:'æ˜µç§°',nickPlaceholder:'è¾“å…¥æ˜µç§°',saveNickBtn:'ä¿å­˜æ˜µç§°',
    changePwdTitle:'ä¿®æ”¹å¯†ç ',lblOldPwd:'æ—§å¯†ç ',lblNewPwd:'æ–°å¯†ç ',changePwdBtn:'ä¿®æ”¹å¯†ç ',logoutBtn:'é€€å‡ºç™»å½•',
    lblHostnameDisplay:'ä¸»æœºåæ˜¾ç¤º',
    lblHostnameSize:'ä¸»æœºåå¤§å°',lblClockSize:'æ—¶é—´å­—ä½“å¤§å°',lblIconSize:'åº”ç”¨å›¾æ ‡å¤§å°',lblAppnameSize:'åº”ç”¨åç§°å¤§å°',
    saveDisplayBtn:'ä¿å­˜',
    ckTime:'æ˜¾ç¤ºæ—¶é—´',ckSec:'æ˜¾ç¤ºç§’',ckDate:'æ˜¾ç¤ºæ—¥æœŸ',ckDateSub:'æœˆ-æ—¥',ckWeek:'æ˜¾ç¤ºæ˜ŸæœŸ',ckLunar:'æ˜¾ç¤ºå†œå†',ckLunarSub:'å¦‚ï¼šæ­£æœˆåˆä¸€',
    lblCustomUrl:'è‡ªå®šä¹‰ URL',applyWpBtn:'åº”ç”¨å£çº¸',
    infoAccounts:'ç®¡ç†é¢æ¿ç™»å½•è´¦å·ã€‚å„è´¦å·ç‹¬ç«‹ç®¡ç†æ•°æ®ã€‚',
    titleAddUser:'æ·»åŠ ç”¨æˆ·',lblNuName:'è´¦å·',lblNuPwd:'å¯†ç ',lblNuNick:'æ˜µç§°ï¼ˆå¯é€‰ï¼‰',addUserBtn:'æ·»åŠ ',
    lblPubMode:'å…¬å¼€è®¿é—®æ¨¡å¼',subPubMode:'æ— éœ€ç™»å½•å³å¯æµè§ˆï¼Œç¼–è¾‘æ“ä½œä»éœ€ç™»å½•',
    lblPrivateMode:'ç§æœ‰æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼š',descPrivateMode:'è®¿é—®é¢æ¿éœ€å…ˆç™»å½•',lblPublicMode:'å…¬å¼€æ¨¡å¼ï¼š',descPublicMode:'ä»»ä½•äººå¯æµè§ˆé¢æ¿ï¼Œç‚¹å‡»è®¾ç½®/ç¼–è¾‘æ—¶å¼¹å‡ºç™»å½•æ¡†',
    infoBackup:'å¤‡ä»½åŒ…å«ï¼šæ‰€æœ‰åº”ç”¨å›¾æ ‡ã€é¢æ¿è®¾ç½®ã€æ—¶é’Ÿé…ç½®ã€å£çº¸ä¿¡æ¯ã€‚\nè´¦æˆ·å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ä¸å«åœ¨å¤‡ä»½ä¸­ã€‚',
    exportBtn:'å¯¼å‡ºæ•°æ®',exportDesc:'ä¸‹è½½ JSON å¤‡ä»½æ–‡ä»¶',importBtn:'å¯¼å…¥æ•°æ®',importDesc:'ä»å¤‡ä»½æ–‡ä»¶æ¢å¤',
    lblDanger:'å±é™©æ“ä½œ',clearBtn:'ğŸ—‘ æ¸…ç©ºæ‰€æœ‰åº”ç”¨æ•°æ®',
    tSaved:'å·²ä¿å­˜ âœ“',tFailed:'ä¿å­˜å¤±è´¥',tDeleted:'å·²åˆ é™¤',tDeleteFailed:'åˆ é™¤å¤±è´¥',
    tUploaded:'ä¸Šä¼ æˆåŠŸ',tUploadFailed:'ä¸Šä¼ å¤±è´¥',tSortSaved:'æ’åºå·²ä¿å­˜ âœ“',
    tLoggedOut:'å·²é€€å‡ºç™»å½•',tNickSaved:'æ˜µç§°å·²ä¿å­˜ âœ“',tPwdChanged:'å¯†ç å·²ä¿®æ”¹ âœ“',tPwdFailed:'ä¿®æ”¹å¤±è´¥',
    tUserAdded:'å·²æ·»åŠ  âœ“',tUserAddFailed:'æ·»åŠ å¤±è´¥',tExported:'å¯¼å‡ºæˆåŠŸ âœ“',tExportFailed:'å¯¼å‡ºå¤±è´¥',
    tImported:'å¯¼å…¥æˆåŠŸ âœ“',tImportFailed:'å¯¼å…¥å¤±è´¥',tCleared:'å·²æ¸…ç©º',
    confirmDelete:'ç¡®è®¤åˆ é™¤æ­¤åº”ç”¨ï¼Ÿ',confirmDeleteUser:'ç¡®è®¤åˆ é™¤ç”¨æˆ·',
    confirmImport:'å¯¼å…¥å°†è¦†ç›–å½“å‰æ‰€æœ‰åº”ç”¨å’Œè®¾ç½®ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ',confirmClear:'ç¡®è®¤æ¸…ç©ºæ‰€æœ‰åº”ç”¨æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼',
    fillTitleUrl:'è¯·å¡«å†™æ ‡é¢˜å’Œåœ°å€',fillPwd:'è¯·å¡«å†™å¯†ç ',fillAccountPwd:'è¯·å¡«å†™è´¦å·å’Œå¯†ç ',badBackup:'å¤‡ä»½æ–‡ä»¶æ ¼å¼é”™è¯¯',
    pleaseLogin:'è¯·ç™»å½•ä»¥è®¿é—®é¢æ¿',loginRequired:'éœ€è¦ç™»å½•æ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ',
    thColAccount:'è´¦å·',thColNickname:'æ˜µç§°',thColRole:'è§’è‰²',thColAction:'æ“ä½œ',
    roleAdmin:'ç®¡ç†å‘˜',roleUser:'ç”¨æˆ·',badgeCurrent:'å½“å‰',deleteUserBtn:'åˆ é™¤',
    pubOn:'å·²å¼€å¯å…¬å¼€è®¿é—®',pubOff:'å·²åˆ‡æ¢ä¸ºç§æœ‰æ¨¡å¼',
    weekdays:['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'],
  },
  en: {
    loginSub:'Please sign in to continue',loginBtn:'Sign In',loginErr:'Invalid username or password',
    addApp:'Add App',editApp:'Edit App',appNamePrev:'App Name',
    iconStyle:'Icon Style',textIcon:'Text',imageIcon:'Image',
    iconPlaceholder:'Text (max 2 chars)',iconUrlPlaceholder:'Enter icon URL or upload',
    titleLbl:'Title *',urlLbl:'URL *',openLbl:'Open Mode',
    newTab:'New Tab',currentTab:'Current Tab',
    deleteBtn:'Delete',cancelBtn:'Cancel',saveBtn:'Save',editLabel:'Edit',
    sysSettings:'System Settings',
    niAccount:'My Profile',niPanel:'Personalize',niDisplay:'Display Size',niTheme:'Theme',niClock:'Clock',niWallpaper:'Wallpaper',niUsers:'Accounts',niAccess:'Access',niBackup:'Data',niLanguage:'Language',
    titleAccount:'ğŸ‘¤ My Profile',titlePanel:'ğŸ¨ Personalize',titleDisplay:'ğŸ“ Display Size',titleTheme:'ğŸŒˆ Theme Color',titleClock:'ğŸ• Clock Widget',titleWallpaper:'ğŸ–¼ï¸ Wallpaper',titleUsers:'ğŸ‘¥ Accounts',titleAccess:'ğŸ”“ Access Control',titleBackup:'ğŸ’¾ Data',
    lblUsername:'Username',lblNickname:'Nickname',nickPlaceholder:'Enter nickname',saveNickBtn:'Save Nickname',
    changePwdTitle:'Change Password',lblOldPwd:'Old Password',lblNewPwd:'New Password',changePwdBtn:'Change Password',logoutBtn:'Sign Out',
    lblHostnameDisplay:'Hostname Display',
    lblHostnameSize:'Hostname Font Size',lblClockSize:'Clock Font Size',lblIconSize:'App Icon Size',lblAppnameSize:'App Name Size',
    saveDisplayBtn:'Save',
    ckTime:'Show Time',ckSec:'Show Seconds',ckDate:'Show Date',ckDateSub:'M-D',ckWeek:'Show Weekday',ckLunar:'Show Lunar',ckLunarSub:'e.g. æ­£æœˆåˆä¸€',
    lblCustomUrl:'Custom URL',applyWpBtn:'Apply Wallpaper',
    infoAccounts:'Manage panel login accounts.',
    titleAddUser:'Add User',lblNuName:'Username',lblNuPwd:'Password',lblNuNick:'Nickname (optional)',addUserBtn:'Add',
    lblPubMode:'Public Access Mode',subPubMode:'Anyone can browse; editing requires login',
    lblPrivateMode:'Private Mode (default): ',descPrivateMode:'Login required to access the panel',lblPublicMode:'Public Mode: ',descPublicMode:'Anyone can browse; settings/edit requires login',
    infoBackup:'Backup includes: all apps, panel settings, clock config, wallpaper.\nPasswords and sensitive data excluded.',
    exportBtn:'Export',exportDesc:'Download JSON backup',importBtn:'Import',importDesc:'Restore from backup',
    lblDanger:'Danger Zone',clearBtn:'ğŸ—‘ Clear All App Data',
    tSaved:'Saved âœ“',tFailed:'Save failed',tDeleted:'Deleted',tDeleteFailed:'Delete failed',
    tUploaded:'Uploaded',tUploadFailed:'Upload failed',tSortSaved:'Order saved âœ“',
    tLoggedOut:'Signed out',tNickSaved:'Nickname saved âœ“',tPwdChanged:'Password changed âœ“',tPwdFailed:'Change failed',
    tUserAdded:'Added âœ“',tUserAddFailed:'Add failed',tExported:'Exported âœ“',tExportFailed:'Export failed',
    tImported:'Imported âœ“',tImportFailed:'Import failed',tCleared:'Cleared',
    confirmDelete:'Delete this app?',confirmDeleteUser:'Delete user',
    confirmImport:'Import will overwrite all apps and settings. Continue?',confirmClear:'Clear all app data? This cannot be undone!',
    fillTitleUrl:'Please fill in title and URL',fillPwd:'Please enter passwords',fillAccountPwd:'Please fill in username and password',badBackup:'Invalid backup file',
    pleaseLogin:'Please login to access the panel',loginRequired:'Login required for this action',
    thColAccount:'Username',thColNickname:'Nickname',thColRole:'Role',thColAction:'Action',
    roleAdmin:'Admin',roleUser:'User',badgeCurrent:'current',deleteUserBtn:'Delete',
    pubOn:'Public access enabled',pubOff:'Switched to private mode',
    weekdays:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],
  }
};

let lang = localStorage.getItem('ep_lang') || 'zh';
function s(k) { return (STRINGS[lang]||STRINGS.zh)[k] || STRINGS.zh[k] || k; }

function applyLang() {
  // Login
  document.getElementById('login-sub').textContent = s('loginSub');
  document.getElementById('login-btn-el').textContent = s('loginBtn');
  document.getElementById('lerr').textContent = s('loginErr');
  document.getElementById('lu').placeholder = s('lblUsername');
  document.getElementById('lp').placeholder = 'Password';
  // Modal
  document.getElementById('lbl-icon-style').textContent = s('iconStyle');
  document.getElementById('itab-text').textContent = s('textIcon');
  document.getElementById('itab-image').textContent = s('imageIcon');
  document.getElementById('icon-txt').placeholder = s('iconPlaceholder');
  document.getElementById('icon-url').placeholder = s('iconUrlPlaceholder');
  document.getElementById('lbl-title').textContent = s('titleLbl');
  document.getElementById('lbl-url').textContent = s('urlLbl');
  document.getElementById('lbl-open').textContent = s('openLbl');
  document.getElementById('opt-newtab').textContent = s('newTab');
  document.getElementById('opt-current').textContent = s('currentTab');
  document.getElementById('btn-cancel-modal').textContent = s('cancelBtn');
  document.getElementById('btn-save-app').textContent = s('saveBtn');
  // Context menu
  document.getElementById('ctx-edit-label').textContent = s('editLabel');
  document.getElementById('ctx-del-label').textContent = s('deleteBtn');
  // Settings nav
  document.getElementById('s-nav-title').textContent = s('sysSettings');
  document.getElementById('ni-account').textContent = s('niAccount');
  document.getElementById('ni-panel').textContent = s('niPanel');
  document.getElementById('ni-display').textContent = s('niDisplay');
  document.getElementById('ni-theme').textContent = s('niTheme');
  document.getElementById('ni-clock').textContent = s('niClock');
  document.getElementById('ni-wallpaper').textContent = s('niWallpaper');
  document.getElementById('ni-users').textContent = s('niUsers');
  document.getElementById('ni-access').textContent = s('niAccess');
  document.getElementById('ni-backup').textContent = s('niBackup');
  document.getElementById('ni-language').textContent = s('niLanguage');
  // My info
  document.getElementById('title-account').textContent = s('titleAccount');
  document.getElementById('lbl-username').textContent = s('lblUsername');
  document.getElementById('lbl-nickname').textContent = s('lblNickname');
  document.getElementById('s-nick').placeholder = s('nickPlaceholder');
  document.getElementById('btn-save-nick').textContent = s('saveNickBtn');
  document.getElementById('title-change-pwd').textContent = s('changePwdTitle');
  document.getElementById('lbl-old-pwd').textContent = s('lblOldPwd');
  document.getElementById('lbl-new-pwd').textContent = s('lblNewPwd');
  document.getElementById('btn-change-pwd').textContent = s('changePwdBtn');
  document.getElementById('btn-logout').textContent = s('logoutBtn');
  // Panel
  document.getElementById('title-panel').textContent = s('titlePanel');
  document.getElementById('lbl-hostname-display').textContent = s('lblHostnameDisplay');
  document.getElementById('btn-save-panel').textContent = s('saveBtn');
  // Display size
  document.getElementById('title-display').textContent = s('titleDisplay');
  document.getElementById('lbl-hostname-size').textContent = s('lblHostnameSize');
  document.getElementById('lbl-clock-size').textContent = s('lblClockSize');
  document.getElementById('lbl-icon-size').textContent = s('lblIconSize');
  document.getElementById('lbl-appname-size').textContent = s('lblAppnameSize');
  document.getElementById('btn-save-display').textContent = s('saveDisplayBtn');
  // Theme
  document.getElementById('title-theme').textContent = s('titleTheme');
  // Clock
  document.getElementById('title-clock').textContent = s('titleClock');
  document.getElementById('ck-lbl-time').textContent = s('ckTime');
  document.getElementById('ck-lbl-sec').textContent = s('ckSec');
  document.getElementById('ck-lbl-date').textContent = s('ckDate');
  document.getElementById('ck-sub-date').textContent = s('ckDateSub');
  document.getElementById('ck-lbl-week').textContent = s('ckWeek');
  document.getElementById('ck-lbl-lunar').textContent = s('ckLunar');
  document.getElementById('ck-sub-lunar').textContent = s('ckLunarSub');
  // Wallpaper
  document.getElementById('title-wallpaper').textContent = s('titleWallpaper');
  document.getElementById('lbl-custom-url').textContent = s('lblCustomUrl');
  document.getElementById('btn-apply-wp').textContent = s('applyWpBtn');
  // Users
  document.getElementById('title-users').textContent = s('titleUsers');
  document.getElementById('info-accounts').textContent = s('infoAccounts');
  document.getElementById('title-add-user').textContent = s('titleAddUser');
  document.getElementById('lbl-nu-name').textContent = s('lblNuName');
  document.getElementById('lbl-nu-pwd').textContent = s('lblNuPwd');
  document.getElementById('lbl-nu-nick').textContent = s('lblNuNick');
  document.getElementById('btn-add-user').textContent = s('addUserBtn');
  // Access
  document.getElementById('title-access').textContent = s('titleAccess');
  document.getElementById('lbl-pub-mode').textContent = s('lblPubMode');
  document.getElementById('sub-pub-mode').textContent = s('subPubMode');
  document.getElementById('lbl-private-mode').textContent = s('lblPrivateMode');
  document.getElementById('desc-private-mode').textContent = s('descPrivateMode');
  document.getElementById('lbl-public-mode').textContent = s('lblPublicMode');
  document.getElementById('desc-public-mode').textContent = s('descPublicMode');
  // Backup
  document.getElementById('title-backup').textContent = s('titleBackup');
  document.getElementById('info-backup').innerHTML = s('infoBackup').replace('\n','<br>');
  document.getElementById('btn-export').textContent = s('exportBtn');
  document.getElementById('desc-export').textContent = s('exportDesc');
  document.getElementById('btn-import').textContent = s('importBtn');
  document.getElementById('desc-import').textContent = s('importDesc');
  document.getElementById('lbl-danger').textContent = s('lblDanger');
  document.getElementById('btn-clear').textContent = s('clearBtn');
  // Language buttons
  document.getElementById('lang-zh').classList.toggle('active', lang==='zh');
  document.getElementById('lang-en').classList.toggle('active', lang==='en');
}

function setLang(l) {
  lang = l;
  localStorage.setItem('ep_lang', l);
  applyLang();
  if (curUser) {
    const sv = buildSettingsPayload();
    sv.language = l;
    api('/api/settings', {method:'PUT', body: JSON.stringify(sv)}).catch(()=>{});
  }
  showToast(s('tSaved'));
}

// â”€â”€ THEMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const THEMES=[
  {id:'purple-pink',name:'ç´«ç²‰',h1:'#a855f7',h2:'#ec4899',dot:'linear-gradient(135deg,#a855f7,#ec4899)',wp:'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=1920&q=80'},
  {id:'blue-cyan',name:'è“é’',h1:'#3b82f6',h2:'#06b6d4',dot:'linear-gradient(135deg,#3b82f6,#06b6d4)',wp:'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=1920&q=80'},
  {id:'green-teal',name:'ç»¿é’',h1:'#22c55e',h2:'#14b8a6',dot:'linear-gradient(135deg,#22c55e,#14b8a6)',wp:'https://images.unsplash.com/photo-1501854140801-50d01698950b?w=1920&q=80'},
  {id:'orange-red',name:'æ©™çº¢',h1:'#f97316',h2:'#ef4444',dot:'linear-gradient(135deg,#f97316,#ef4444)',wp:'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=1920&q=80'},
  {id:'dark-blue',name:'æ·±è“',h1:'#1d4ed8',h2:'#7c3aed',dot:'linear-gradient(135deg,#1d4ed8,#7c3aed)',wp:'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=1920&q=80'},
  {id:'rose-gold',name:'ç«ç‘°é‡‘',h1:'#f43f5e',h2:'#fb923c',dot:'linear-gradient(135deg,#f43f5e,#fb923c)',wp:'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80'},
  {id:'indigo-violet',name:'é›ç´«',h1:'#6366f1',h2:'#8b5cf6',dot:'linear-gradient(135deg,#6366f1,#8b5cf6)',wp:'https://images.unsplash.com/photo-1548484352-ea579e5233a8?w=1920&q=80'},
];
let curTheme=THEMES[0];
function applyTheme(th,save){
  curTheme=th;
  const r=document.documentElement.style;
  r.setProperty('--h1',th.h1);r.setProperty('--h2',th.h2);
  r.setProperty('--grad',`linear-gradient(135deg,${th.h1},${th.h2})`);
  document.querySelectorAll('.theme-item').forEach(el=>el.classList.toggle('sel',el.dataset.tid===th.id));
  if(save){localStorage.setItem('ep_theme',th.id);if(curUser)saveThemeToServer(th.id);}
}
function loadTheme(){const saved=localStorage.getItem('ep_theme')||panelInfo.theme||'purple-pink';const th=THEMES.find(x=>x.id===saved)||THEMES[0];applyTheme(th,false);}
function buildThemeGrid(){const g=document.getElementById('theme-grid');g.innerHTML=THEMES.map(th=>`<div class="theme-item${th.id===curTheme.id?' sel':''}" data-tid="${th.id}" onclick="applyTheme(THEMES.find(x=>x.id==='${th.id}'),true)"><div class="theme-dot" style="background:${th.dot}"></div><div class="theme-name">${th.name}</div></div>`).join('');}
async function saveThemeToServer(themeId){try{const sv=buildSettingsPayload();sv.theme=themeId;await api('/api/settings',{method:'PUT',body:JSON.stringify(sv)});panelInfo.theme=themeId;}catch(e){}}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let apps=[],panelInfo={},clkCfg={show_time:true,show_date:true,show_weekday:true,show_lunar:false,show_seconds:false};
let curUser=null,pubMode=false,editId=null,iconType='text',sortMode=false,ctxId=null,loginCb=null,clkTimer=null;
let dispSet={hostnameSize:56,clockSize:16,iconSize:78,appNameSize:12};

const WPS=['https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=1920&q=80','https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80','https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=1920&q=80','https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=1920&q=80','https://images.unsplash.com/photo-1519681393784-d120267933ba?w=1920&q=80','https://images.unsplash.com/photo-1548484352-ea579e5233a8?w=1920&q=80'];

async function api(url,o={}){const r=await fetch(url,{headers:{'Content-Type':'application/json'},credentials:'include',...o});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error||'failed');}return r.json();}

function buildSettingsPayload(){
  return {
    hostname:panelInfo.hostname||'',logo:panelInfo.logo||'',wallpaper:panelInfo.wallpaper||'',
    clock:clkCfg,theme:curTheme.id,language:lang,
    hostname_size:dispSet.hostnameSize,clock_size:dispSet.clockSize,
    icon_size:dispSet.iconSize,app_name_size:dispSet.appNameSize,
  };
}

// â”€â”€ DISPLAY SIZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyDispSet(ds){
  dispSet=ds;
  document.getElementById('hero-hostname').style.fontSize=ds.hostnameSize+'px';
  document.getElementById('hero-clock').style.fontSize=ds.clockSize+'px';
  document.querySelectorAll('.app-icon-wrap').forEach(el=>{el.style.width=ds.iconSize+'px';el.style.height=ds.iconSize+'px';});
  document.querySelectorAll('.app-name').forEach(el=>{el.style.fontSize=ds.appNameSize+'px';el.style.maxWidth=(ds.iconSize+10)+'px';});
  document.querySelectorAll('.app-card').forEach(el=>{el.style.width=(ds.iconSize+14)+'px';});
}

function updSlider(key){
  const map={hostname:{sl:'sl-hostname',sv:'sv-hostname',k:'hostnameSize'},clock:{sl:'sl-clock',sv:'sv-clock',k:'clockSize'},icon:{sl:'sl-icon',sv:'sv-icon',k:'iconSize'},appname:{sl:'sl-appname',sv:'sv-appname',k:'appNameSize'}};
  const c=map[key];const val=parseInt(document.getElementById(c.sl).value);
  document.getElementById(c.sv).textContent=val+'px';
  applyDispSet({...dispSet,[c.k]:val});
}

async function saveDisplaySettings(){
  const ds={hostnameSize:parseInt(document.getElementById('sl-hostname').value),clockSize:parseInt(document.getElementById('sl-clock').value),iconSize:parseInt(document.getElementById('sl-icon').value),appNameSize:parseInt(document.getElementById('sl-appname').value)};
  dispSet=ds;
  const sv=buildSettingsPayload();
  try{await api('/api/settings',{method:'PUT',body:JSON.stringify(sv)});applyDispSet(ds);showToast(s('tSaved'));}
  catch(e){showToast(s('tFailed'));}
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init(){
  await loadPanel();
  loadTheme();
  await loadApps();
  startClock();
  const auth=await api('/api/checkauth').catch(()=>({logged_in:false}));
  if(auth.logged_in)curUser=auth;
  if(!pubMode&&!curUser)showLogin(s('pleaseLogin'),()=>hideLogin());
  applyLang();
}

async function loadPanel(){
  try{
    panelInfo=await api('/api/panel');
    pubMode=panelInfo.public_mode||false;
    clkCfg=panelInfo.clock||clkCfg;
    const savedLang=panelInfo.language||localStorage.getItem('ep_lang')||'zh';
    lang=savedLang;localStorage.setItem('ep_lang',lang);
    document.getElementById('hero-hostname').textContent=panelInfo.hostname||'EasyPanel';
    const ds={hostnameSize:panelInfo.hostname_size||56,clockSize:panelInfo.clock_size||16,iconSize:panelInfo.icon_size||78,appNameSize:panelInfo.app_name_size||12};
    applyDispSet(ds);
    const bg=document.getElementById('wp-bg');
    if(panelInfo.wallpaper)bg.style.backgroundImage=`url(${panelInfo.wallpaper})`;
    else bg.style.backgroundImage=`url(${curTheme.wp||WPS[0]})`;
    const logo=document.getElementById('dash-logo');
    if(panelInfo.logo){logo.src=panelInfo.logo;logo.style.display='block';}
  }catch(e){console.error(e);}
}

async function loadApps(){try{apps=await api('/api/apps');renderApps();}catch(e){console.error(e);}}

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLogin(sub,cb){loginCb=cb;document.getElementById('login-sub').textContent=sub||s('loginSub');document.getElementById('lerr').style.display='none';document.getElementById('lu').value='';document.getElementById('lp').value='';document.getElementById('login-overlay').classList.remove('hidden');setTimeout(()=>document.getElementById('lu').focus(),80);}
function hideLogin(){document.getElementById('login-overlay').classList.add('hidden');loginCb=null;}
async function doLogin(){const u=document.getElementById('lu').value.trim(),p=document.getElementById('lp').value;document.getElementById('lerr').style.display='none';try{const r=await api('/api/login',{method:'POST',body:JSON.stringify({username:u,password:p})});curUser=r;hideLogin();if(loginCb){loginCb();loginCb=null;}}catch(e){document.getElementById('lerr').style.display='block';}}
document.getElementById('lp').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
async function doLogout(){await api('/api/logout',{method:'POST'}).catch(()=>{});curUser=null;closeSettings();if(!pubMode)showLogin(s('pleaseLogin'),()=>hideLogin());showToast(s('tLoggedOut'));}
function requireAuth(cb){if(curUser){cb();return;}showLogin(s('loginRequired'),()=>{hideLogin();cb();});}
document.getElementById('btn-settings').addEventListener('click',()=>requireAuth(openSettings));

// â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startClock(){if(clkTimer)clearInterval(clkTimer);tick();clkTimer=setInterval(tick,1000);}
function tick(){const now=new Date(),parts=[],pad=n=>String(n).padStart(2,'0');if(clkCfg.show_time){let tv=`${pad(now.getHours())}:${pad(now.getMinutes())}`;if(clkCfg.show_seconds)tv+=`:${pad(now.getSeconds())}`;parts.push(`<span>${tv}</span>`);}const days=s('weekdays');const items=[];if(clkCfg.show_date)items.push(`${now.getMonth()+1}-${now.getDate()}`);if(clkCfg.show_weekday)items.push(days[now.getDay()]);if(clkCfg.show_lunar&&lang==='zh'){const l=getLunar(now);if(l)items.push(l);}if(items.length)parts.push(`<span class="div">|</span><span>${items.join(' &nbsp;')}</span>`);document.getElementById('hero-clock').innerHTML=parts.join('');}

// â”€â”€ RENDER APPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderApps(){
  const w=document.getElementById('apps-inner');w.innerHTML='';
  const row=document.createElement('div');row.className='group-row';
  row.innerHTML=`<div class="group-lbl">APP</div><div class="group-tools"><button class="tool-btn" id="btn-add" title="${s('addApp')}"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button><button class="tool-btn" id="btn-sort" title="Sort"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg></button></div>`;
  w.appendChild(row);
  const sb=document.createElement('div');sb.id='sort-bar';sb.style.cssText='display:none;gap:8px;flex-wrap:wrap;margin-bottom:14px';
  sb.innerHTML=`<button class="sort-btn" onclick="exitSort(true)">ğŸ’¾ ${lang==='en'?'Save Order':'ä¿å­˜æ’åº'}</button><button class="sort-btn" style="background:rgba(255,255,255,.6)" onclick="exitSort(false)">âœ• ${s('cancelBtn')}</button>`;
  w.appendChild(sb);
  const grid=document.createElement('div');grid.className='apps-grid';grid.id='apps-grid';
  apps.forEach(a=>grid.appendChild(mkCard(a)));
  w.appendChild(grid);
  document.getElementById('btn-add').onclick=()=>requireAuth(openAdd);
  document.getElementById('btn-sort').onclick=()=>requireAuth(enterSort);
}

function mkCard(app){
  const card=document.createElement('div');card.className='app-card';card.dataset.id=app.id;
  card.style.width=(dispSet.iconSize+14)+'px';
  const title=app.title||'?',fb=title.substring(0,2);
  let ico='';
  if(app.icon_type==='image'&&app.icon_image){ico=`<img class="app-icon-img" src="${app.icon_image}" alt="${title}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="app-icon-txt" style="display:none">${fb}</div>`;}
  else{const tv=(app.icon_text&&app.icon_text.trim())?app.icon_text.trim():fb;ico=`<div class="app-icon-txt">${tv}</div>`;}
  const wrap=document.createElement('div');wrap.className='app-icon-wrap';wrap.innerHTML=ico;
  wrap.style.width=dispSet.iconSize+'px';wrap.style.height=dispSet.iconSize+'px';
  const br=Math.round(dispSet.iconSize*0.26)+'px';wrap.style.borderRadius=br;
  const txtIcon=wrap.querySelector('.app-icon-txt');
  if(txtIcon){txtIcon.style.fontSize=Math.round(dispSet.iconSize*0.33)+'px';txtIcon.style.borderRadius=br;}
  const imgIcon=wrap.querySelector('.app-icon-img');if(imgIcon)imgIcon.style.borderRadius=br;
  const nm=document.createElement('div');nm.className='app-name';nm.textContent=title;
  nm.style.fontSize=dispSet.appNameSize+'px';nm.style.maxWidth=(dispSet.iconSize+10)+'px';
  card.appendChild(wrap);card.appendChild(nm);
  wrap.addEventListener('click',()=>{if(sortMode)return;if(!app.url)return;app.open_type==='current'?(window.location.href=app.url):window.open(app.url,'_blank');});
  card.addEventListener('contextmenu',e=>{e.preventDefault();if(sortMode)return;requireAuth(()=>showCtx(e.clientX,e.clientY,app.id));});
  card.draggable=true;
  card.addEventListener('dragstart',e=>{if(!sortMode){e.preventDefault();return;}e.dataTransfer.effectAllowed='move';card.style.opacity='.35';card.dataset.drag='1';});
  card.addEventListener('dragend',()=>{card.style.opacity='';delete card.dataset.drag;document.querySelectorAll('.app-card').forEach(c=>c.classList.remove('drag-over'));});
  card.addEventListener('dragover',e=>{if(!sortMode)return;e.preventDefault();card.classList.add('drag-over');});
  card.addEventListener('dragleave',()=>card.classList.remove('drag-over'));
  card.addEventListener('drop',e=>{e.preventDefault();card.classList.remove('drag-over');const sg=document.querySelector('.app-card[data-drag="1"]');if(!sg||sg===card)return;reorderLocal(sg.dataset.id,card.dataset.id);});
  return card;
}

function reorderLocal(si,di){const a=apps.findIndex(x=>x.id===si),b=apps.findIndex(x=>x.id===di);if(a<0||b<0)return;const[it]=apps.splice(a,1);apps.splice(b,0,it);renderApps();enterSort();}
function enterSort(){sortMode=true;const sb=document.getElementById('sort-bar');if(sb)sb.style.display='flex';document.querySelectorAll('.app-card').forEach(c=>c.classList.add('sort-mode'));const btn=document.getElementById('btn-sort');if(btn)btn.classList.add('active');}
async function exitSort(save){sortMode=false;const sb=document.getElementById('sort-bar');if(sb)sb.style.display='none';document.querySelectorAll('.app-card').forEach(c=>c.classList.remove('sort-mode'));if(save){try{await api('/api/apps/reorder',{method:'POST',body:JSON.stringify({ids:apps.map(a=>a.id)})});showToast(s('tSortSaved'));}catch(e){showToast('failed');}}else await loadApps();}

// â”€â”€ CONTEXT MENU (fixed - events bound once) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ctxEl = document.getElementById('ctx');

// Bind events on the context menu items directly
document.getElementById('ctx-edit-item').addEventListener('mousedown', e => {
  e.stopPropagation();
  const id = ctxId;
  hideCtx();
  if (id) openEdit(id);
});
document.getElementById('ctx-del-item').addEventListener('mousedown', e => {
  e.stopPropagation();
  const id = ctxId;
  hideCtx();
  if (!id) return;
  if (!confirm(s('confirmDelete'))) return;
  api(`/api/apps/${id}`, {method:'DELETE'})
    .then(() => { loadApps(); showToast(s('tDeleted')); })
    .catch(() => showToast(s('tDeleteFailed')));
});

function showCtx(x, y, id) {
  ctxId = id;
  ctxEl.classList.add('show');
  const w=150, h=90;
  ctxEl.style.left = (x+w > innerWidth ? x-w : x) + 'px';
  ctxEl.style.top  = (y+h > innerHeight ? y-h : y) + 'px';
}
function hideCtx() { ctxEl.classList.remove('show'); ctxId = null; }
document.addEventListener('click', e => { if (!ctxEl.contains(e.target)) hideCtx(); });
document.addEventListener('scroll', hideCtx, true);

// â”€â”€ APP MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAdd(){editId=null;document.getElementById('modal-title').textContent=s('addApp');document.getElementById('modal-del').style.display='none';resetModal();document.getElementById('app-modal').classList.add('show');}
function openEdit(id){const a=apps.find(x=>x.id===id);if(!a)return;editId=id;document.getElementById('modal-title').textContent=s('editApp');document.getElementById('modal-del').textContent=s('deleteBtn');document.getElementById('modal-del').style.display='block';setIT(a.icon_type||'text');document.getElementById('icon-txt').value=a.icon_text||'';document.getElementById('icon-url').value=a.icon_image||'';document.getElementById('app-title').value=a.title||'';document.getElementById('app-url').value=a.url||'';document.getElementById('app-open').value=a.open_type||'new_tab';updPrev();document.getElementById('app-modal').classList.add('show');}
function closeModal(){document.getElementById('app-modal').classList.remove('show');}
function resetModal(){setIT('text');['icon-txt','icon-url','app-title','app-url'].forEach(id=>document.getElementById(id).value='');document.getElementById('app-open').value='new_tab';updPrev();}
function setIT(tv){iconType=tv;document.querySelectorAll('.itab').forEach((el,i)=>el.classList.toggle('active',(i===0&&tv==='text')||(i===1&&tv==='image')));document.getElementById('it-text').style.display=tv==='text'?'block':'none';document.getElementById('it-img').style.display=tv==='image'?'block':'none';updPrev();}
function updPrev(){const title=document.getElementById('app-title').value||s('appNamePrev'),url=document.getElementById('app-url').value||'https://...',txt=document.getElementById('icon-txt').value||title.substring(0,2),img=document.getElementById('icon-url').value;document.getElementById('prev-t').textContent=title;document.getElementById('prev-u').textContent=url;const ico=document.getElementById('prev-ico');if(iconType==='image'&&img)ico.innerHTML=`<img src="${img}" style="width:100%;height:100%;object-fit:cover;border-radius:12px" onerror="this.parentElement.textContent='${txt.substring(0,2)}'">`;else ico.textContent=txt.substring(0,2);}
async function uploadIcon(inp){if(!inp.files[0])return;const fd=new FormData();fd.append('image',inp.files[0]);try{const r=await fetch('/api/upload',{method:'POST',body:fd,credentials:'include'});const d=await r.json();document.getElementById('icon-url').value=d.url;updPrev();showToast(s('tUploaded'));}catch(e){showToast(s('tUploadFailed'));}}
async function saveApp(){const title=document.getElementById('app-title').value.trim(),url=document.getElementById('app-url').value.trim();if(!title||!url){showToast(s('fillTitleUrl'));return;}const data={title,url,icon_type:iconType,icon_text:document.getElementById('icon-txt').value,icon_image:document.getElementById('icon-url').value,open_type:document.getElementById('app-open').value};try{if(editId)await api(`/api/apps/${editId}`,{method:'PUT',body:JSON.stringify(data)});else await api('/api/apps',{method:'POST',body:JSON.stringify(data)});closeModal();await loadApps();showToast(s('tSaved'));}catch(e){showToast(s('tFailed'));}}
async function delApp(){if(!editId||!confirm(s('confirmDelete')))return;try{await api(`/api/apps/${editId}`,{method:'DELETE'});closeModal();await loadApps();showToast(s('tDeleted'));}catch(e){showToast(s('tDeleteFailed'));}}
document.getElementById('app-modal').addEventListener('click',e=>{if(e.target===document.getElementById('app-modal'))closeModal();});

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S_TABS=['account','panel','display','theme','clock','wallpaper','users','access','backup','language'];
async function openSettings(){
  if(curUser){document.getElementById('s-uname').value=curUser.username||'';document.getElementById('s-nick').value=curUser.nickname||'';}
  document.getElementById('s-host').value=panelInfo.hostname||'';
  document.getElementById('s-logo').value=panelInfo.logo||'';
  if(panelInfo.logo){document.getElementById('logo-prv').src=panelInfo.logo;document.getElementById('logo-prv').style.display='block';}
  document.getElementById('wp-url').value=panelInfo.wallpaper||'';
  const c=clkCfg;
  document.getElementById('ck-time').checked=c.show_time!==false;document.getElementById('ck-sec').checked=!!c.show_seconds;
  document.getElementById('ck-date').checked=c.show_date!==false;document.getElementById('ck-week').checked=c.show_weekday!==false;
  document.getElementById('ck-lunar').checked=!!c.show_lunar;
  document.getElementById('pub-toggle').checked=pubMode;
  // sliders
  document.getElementById('sl-hostname').value=dispSet.hostnameSize;document.getElementById('sv-hostname').textContent=dispSet.hostnameSize+'px';
  document.getElementById('sl-clock').value=dispSet.clockSize;document.getElementById('sv-clock').textContent=dispSet.clockSize+'px';
  document.getElementById('sl-icon').value=dispSet.iconSize;document.getElementById('sv-icon').textContent=dispSet.iconSize+'px';
  document.getElementById('sl-appname').value=dispSet.appNameSize;document.getElementById('sv-appname').textContent=dispSet.appNameSize+'px';
  buildThemeGrid();buildWpGrid();await loadUsers();
  document.getElementById('s-backdrop').classList.add('show');
  document.getElementById('s-panel').classList.add('open');
  applyLang();
}
function closeSettings(){document.getElementById('s-backdrop').classList.remove('show');document.getElementById('s-panel').classList.remove('open');}
function sTab(tv){document.querySelectorAll('.s-ni').forEach((el,i)=>el.classList.toggle('active',S_TABS[i]===tv));S_TABS.forEach(x=>document.getElementById('st-'+x).classList.toggle('active',x===tv));}

async function saveNick(){const n=document.getElementById('s-nick').value.trim();try{await api('/api/me/nickname',{method:'PUT',body:JSON.stringify({nickname:n})});if(curUser)curUser.nickname=n;showToast(s('tNickSaved'));}catch(e){showToast(s('tFailed'));}}
async function changePwd(){const o=document.getElementById('s-opwd').value,n=document.getElementById('s-npwd').value;if(!o||!n){showToast(s('fillPwd'));return;}try{await api('/api/me/password',{method:'PUT',body:JSON.stringify({old_password:o,new_password:n})});document.getElementById('s-opwd').value='';document.getElementById('s-npwd').value='';showToast(s('tPwdChanged'));}catch(e){showToast(s('tPwdFailed'));}}
async function savePanelCfg(){const sv=buildSettingsPayload();sv.hostname=document.getElementById('s-host').value.trim();sv.logo=document.getElementById('s-logo').value.trim();try{await api('/api/settings',{method:'PUT',body:JSON.stringify(sv)});await loadPanel();showToast(s('tSaved'));}catch(e){showToast(s('tFailed'));}}
function prvLogo(){const u=document.getElementById('s-logo').value;if(u){document.getElementById('logo-prv').src=u;document.getElementById('logo-prv').style.display='block';}}
async function uploadLogo(inp){if(!inp.files[0])return;const fd=new FormData();fd.append('logo',inp.files[0]);try{const r=await fetch('/api/upload/logo',{method:'POST',body:fd,credentials:'include'});const d=await r.json();document.getElementById('s-logo').value=d.url;document.getElementById('logo-prv').src=d.url;document.getElementById('logo-prv').style.display='block';showToast(s('tUploaded'));}catch(e){showToast(s('tUploadFailed'));}}
async function saveClk(){clkCfg={show_time:document.getElementById('ck-time').checked,show_seconds:document.getElementById('ck-sec').checked,show_date:document.getElementById('ck-date').checked,show_weekday:document.getElementById('ck-week').checked,show_lunar:document.getElementById('ck-lunar').checked};const sv=buildSettingsPayload();try{await api('/api/settings',{method:'PUT',body:JSON.stringify(sv)});tick();}catch(e){}}
function buildWpGrid(){const g=document.getElementById('wp-grid');g.innerHTML='';WPS.forEach(url=>{const d=document.createElement('div');d.className='wp-thumb'+(panelInfo.wallpaper===url?' sel':'');d.onclick=()=>selWp(url);d.innerHTML=`<img src="${url}" loading="lazy">`;g.appendChild(d);});}
function selWp(url){document.getElementById('wp-url').value=url;prvWp(url);document.querySelectorAll('.wp-thumb').forEach(el=>el.classList.remove('sel'));}
function prvWp(url){const bg=document.getElementById('wp-bg');if(url)bg.style.backgroundImage=`url(${url})`;else bg.style.backgroundImage=`url(${curTheme.wp||WPS[0]})`;}
async function uploadWp(inp){if(!inp.files[0])return;const fd=new FormData();fd.append('wallpaper',inp.files[0]);try{const r=await fetch('/api/upload/wallpaper',{method:'POST',body:fd,credentials:'include'});const d=await r.json();document.getElementById('wp-url').value=d.url;prvWp(d.url);showToast(s('tUploaded'));}catch(e){showToast(s('tUploadFailed'));}}
async function saveWp(){const url=document.getElementById('wp-url').value.trim();const sv=buildSettingsPayload();sv.wallpaper=url;try{await api('/api/settings',{method:'PUT',body:JSON.stringify(sv)});panelInfo.wallpaper=url;showToast(s('tSaved'));}catch(e){showToast(s('tFailed'));}}

async function loadUsers(){try{const us=await api('/api/users');document.getElementById('u-table').innerHTML=`<thead><tr><th>${s('thColAccount')}</th><th>${s('thColNickname')}</th><th>${s('thColRole')}</th><th>${s('thColAction')}</th></tr></thead><tbody>${us.map(u=>`<tr><td>${u.username}${u.username===curUser?.username?`<span class="badge b-cur">${s('badgeCurrent')}</span>`:''}</td><td>${u.nickname||'-'}</td><td><span class="badge ${u.is_admin?'b-admin':'b-user'}">${u.is_admin?s('roleAdmin'):s('roleUser')}</span></td><td>${u.username!==curUser?.username?`<button class="btn btn-d" style="padding:4px 10px;font-size:12px" onclick="rmUser('${u.username}')">${s('deleteUserBtn')}</button>`:'-'}</td></tr>`).join('')}</tbody>`;}catch(e){console.error(e);}}
async function addUser(){const n=document.getElementById('nu-name').value.trim(),p=document.getElementById('nu-pwd').value,k=document.getElementById('nu-nick').value.trim();if(!n||!p){showToast(s('fillAccountPwd'));return;}try{await api('/api/users',{method:'POST',body:JSON.stringify({username:n,password:p,nickname:k})});document.getElementById('nu-name').value='';document.getElementById('nu-pwd').value='';document.getElementById('nu-nick').value='';await loadUsers();showToast(s('tUserAdded'));}catch(e){showToast(s('tUserAddFailed'));}}
async function rmUser(u){if(!confirm(`${s('confirmDeleteUser')} ${u}ï¼Ÿ`))return;try{await api(`/api/users/${u}`,{method:'DELETE'});await loadUsers();showToast(s('tUserDeleted'));}catch(e){showToast(s('tDeleteFailed'));}}
async function setPubMode(v){try{await api('/api/publicmode',{method:'PUT',body:JSON.stringify({public_mode:v})});pubMode=v;showToast(v?s('pubOn'):s('pubOff'));}catch(e){showToast(s('tFailed'));document.getElementById('pub-toggle').checked=!v;}}

// â”€â”€ BACKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportData(){try{const[appsData,settingsData]=await Promise.all([api('/api/apps'),api('/api/settings')]);const backup={version:1,exported_at:new Date().toISOString(),apps:appsData,settings:settingsData,theme:curTheme.id};const blob=new Blob([JSON.stringify(backup,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`easypanel_backup_${new Date().toISOString().slice(0,10)}.json`;a.click();URL.revokeObjectURL(url);showToast(s('tExported'));}catch(e){showToast(s('tExportFailed'));}}
async function importData(inp){if(!inp.files[0])return;if(!confirm(s('confirmImport'))){inp.value='';return;}try{const text=await inp.files[0].text();const backup=JSON.parse(text);if(!backup.version||!backup.apps){showToast(s('badBackup'));inp.value='';return;}if(backup.settings){await api('/api/settings',{method:'PUT',body:JSON.stringify(backup.settings)});}for(const app of apps){await api(`/api/apps/${app.id}`,{method:'DELETE'}).catch(()=>{});}for(const app of backup.apps){const{id:_,order:__,...rest}=app;await api('/api/apps',{method:'POST',body:JSON.stringify(rest)});}if(backup.theme){const th=THEMES.find(x=>x.id===backup.theme);if(th)applyTheme(th,true);}await loadPanel();await loadApps();showToast(s('tImported'));}catch(e){showToast(s('tImportFailed'));}inp.value='';}
async function clearAllData(){if(!confirm(s('confirmClear')))return;try{for(const app of apps){await api(`/api/apps/${app.id}`,{method:'DELETE'}).catch(()=>{});}await loadApps();showToast(s('tCleared'));}catch(e){showToast(s('tFailed'));}}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastT;
function showToast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),2400);}

init();
</script>
</body>
</html>

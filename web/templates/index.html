<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EasyPanel</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --accent:#22c55e;--accent2:#16a34a;
  --text:#1e293b;--sub:#64748b;
  --radius:18px;--shadow:0 8px 32px rgba(0,0,0,0.15);
  --tr:0.22s cubic-bezier(.4,0,.2,1);
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;min-height:100vh;overflow-x:hidden}

/* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#login-overlay{
  position:fixed;inset:0;z-index:500;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.35);backdrop-filter:blur(8px);
}
#login-overlay.hidden{display:none}

.login-card{
  background:rgba(255,255,255,0.92);backdrop-filter:blur(24px);
  border-radius:24px;padding:40px 44px 32px;width:400px;max-width:95vw;
  box-shadow:0 24px 64px rgba(0,0,0,0.25);
  border:1px solid rgba(255,255,255,0.7);
  animation:card-in .25s ease;
}
@keyframes card-in{from{transform:scale(.95) translateY(12px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}

.login-logo{
  width:40px;height:40px;background:#f1f5f9;border-radius:10px;
  display:flex;align-items:center;justify-content:center;margin-bottom:16px;color:#64748b;
}
.login-title{font-size:26px;font-weight:700;text-align:center;margin-bottom:28px}
.login-sub{font-size:13px;color:#64748b;text-align:center;margin-bottom:20px;margin-top:-18px}

.form-group{position:relative;margin-bottom:14px}
.form-group input{
  width:100%;padding:13px 16px 13px 42px;
  border:1.5px solid #e2e8f0;border-radius:12px;font-size:15px;
  background:rgba(255,255,255,0.9);outline:none;color:#1e293b;
  transition:border-color var(--tr);
}
.form-group input:focus{border-color:var(--accent)}
.form-group .ico{position:absolute;left:13px;top:50%;transform:translateY(-50%);font-size:15px;color:#94a3b8}

.login-btn{
  width:100%;padding:13px;background:#f8fafc;border:1.5px solid #e2e8f0;
  border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;margin-top:6px;
  transition:all var(--tr);color:#1e293b;
}
.login-btn:hover{background:#f1f5f9;transform:translateY(-1px)}
.login-err{color:#ef4444;font-size:13px;text-align:center;margin-top:8px;display:none}
.login-footer{text-align:center;margin-top:18px;font-size:12px;color:#94a3b8}

/* â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#dashboard{min-height:100vh;position:relative}
.wp-bg{
  position:fixed;inset:0;z-index:0;
  background-size:cover;background-position:center;
  transition:background-image .5s;
}
.wp-overlay{position:fixed;inset:0;z-index:0;background:rgba(0,0,0,0.18)}
.dash-content{position:relative;z-index:1;min-height:100vh;padding:0 40px 40px}

/* Header */
.dash-header{display:flex;justify-content:space-between;align-items:center;padding:22px 0}
.dash-logo{width:38px;height:38px;border-radius:10px;object-fit:cover;display:none}
.settings-btn{
  width:40px;height:40px;background:rgba(255,255,255,0.18);backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,0.3);border-radius:10px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;color:white;font-size:17px;
  transition:all var(--tr);
}
.settings-btn:hover{background:rgba(255,255,255,0.28)}

/* Hero */
.hero{text-align:center;padding:16px 0 36px;color:white}
.hero-hostname{font-size:40px;font-weight:800;text-shadow:0 2px 8px rgba(0,0,0,0.3);margin-bottom:6px}
.hero-clock{
  font-size:18px;opacity:.9;text-shadow:0 1px 4px rgba(0,0,0,0.2);
  display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;
}
.hero-clock .divider{opacity:.5}

/* Apps section */
.apps-section{max-width:1280px;margin:0 auto}

.group-label-row{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.group-label{
  color:rgba(255,255,255,.9);font-size:14px;font-weight:600;
  text-transform:uppercase;letter-spacing:1px;text-shadow:0 1px 3px rgba(0,0,0,.3);
}
.group-toolbar{display:none;align-items:center;gap:6px}
.group-label-row:hover .group-toolbar{display:flex}

.toolbar-btn{
  width:28px;height:28px;border-radius:7px;
  border:1.5px solid rgba(255,255,255,.5);background:rgba(255,255,255,.15);
  backdrop-filter:blur(8px);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  color:rgba(255,255,255,.9);font-size:13px;transition:all var(--tr);
}
.toolbar-btn:hover{background:rgba(255,255,255,.3);border-color:rgba(255,255,255,.8)}
.toolbar-btn.sort-active{background:rgba(255,255,255,.35);border-color:white;color:white}

/* Apps grid */
.apps-grid{display:flex;flex-wrap:wrap;gap:18px;margin-bottom:28px}

/* App card */
.app-card{
  position:relative;display:flex;flex-direction:column;
  align-items:center;gap:7px;cursor:pointer;width:88px;
  user-select:none;
}
.app-icon-wrap{
  width:72px;height:72px;border-radius:18px;overflow:hidden;
  transition:transform var(--tr),box-shadow var(--tr);
  box-shadow:0 4px 16px rgba(0,0,0,.2);
}
.app-card:not(.sort-mode):hover .app-icon-wrap{
  transform:translateY(-4px) scale(1.05);
  box-shadow:0 8px 24px rgba(0,0,0,.3);
}
/* sort mode wiggle */
.app-card.sort-mode{animation:wiggle .5s ease infinite alternate}
@keyframes wiggle{from{transform:rotate(-1deg)}to{transform:rotate(1deg)}}
.app-card.sort-mode .app-icon-wrap{
  border:2px dashed rgba(255,255,255,.7);
  transform:none!important;
  box-shadow:0 4px 16px rgba(0,0,0,.2)!important;
}
.app-card.sort-mode.drag-over .app-icon-wrap{border-color:white;background:rgba(255,255,255,.15)}

.app-icon{width:100%;height:100%;object-fit:cover;border-radius:16px}
.app-icon-text{
  width:100%;height:100%;display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.18);backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.3);border-radius:18px;
  font-size:22px;font-weight:700;color:white;text-shadow:0 1px 4px rgba(0,0,0,.3);
}
.app-name{
  font-size:12px;color:rgba(255,255,255,.95);text-align:center;font-weight:500;
  text-shadow:0 1px 3px rgba(0,0,0,.4);max-width:84px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}

/* sort mode container */
#sort-mode-bar{
  display:none;margin-bottom:12px;
}
.sort-save-btn{
  padding:7px 18px;background:rgba(255,255,255,.9);color:#1e293b;
  border:none;border-radius:10px;font-size:13px;font-weight:600;
  cursor:pointer;display:inline-flex;align-items:center;gap:6px;
  box-shadow:0 2px 8px rgba(0,0,0,.15);transition:all var(--tr);
}
.sort-save-btn:hover{background:white;transform:translateY(-1px)}

/* â”€â”€ RIGHT-CLICK MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ctx-menu{
  position:fixed;z-index:900;background:white;
  border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.18);
  padding:6px;min-width:130px;display:none;
  animation:ctx-in .15s ease;
}
@keyframes ctx-in{from{transform:scale(.93);opacity:0}to{transform:scale(1);opacity:1}}
.ctx-menu.show{display:block}
.ctx-item{
  display:flex;align-items:center;gap:9px;padding:9px 12px;
  border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;color:#1e293b;
  transition:background var(--tr);
}
.ctx-item:hover{background:#f1f5f9}
.ctx-item.danger{color:#ef4444}
.ctx-item.danger:hover{background:#fef2f2}

/* â”€â”€ ADD/EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay{
  position:fixed;inset:0;z-index:600;background:rgba(0,0,0,.45);
  backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;
}
.modal-overlay.show{display:flex}
.modal{
  background:white;border-radius:20px;padding:28px;
  width:480px;max-width:95vw;max-height:90vh;overflow-y:auto;
  box-shadow:0 20px 60px rgba(0,0,0,.25);animation:card-in .2s ease;
}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px}
.modal-title{font-size:17px;font-weight:700}
.modal-close{
  width:30px;height:30px;border:none;background:#f1f5f9;
  border-radius:8px;cursor:pointer;font-size:15px;
  display:flex;align-items:center;justify-content:center;color:#64748b;
  transition:all var(--tr);
}
.modal-close:hover{background:#e2e8f0}

.preview-area{
  background:#f8fafc;border-radius:12px;padding:14px;
  margin-bottom:18px;display:flex;align-items:center;gap:14px;
}
.preview-icon{
  width:52px;height:52px;border-radius:13px;overflow:hidden;flex-shrink:0;
  background:#e2e8f0;display:flex;align-items:center;justify-content:center;
  font-size:18px;font-weight:700;color:#64748b;
}
.preview-icon img{width:100%;height:100%;object-fit:cover}
.preview-title{font-size:14px;font-weight:600}
.preview-url{font-size:12px;color:#64748b;margin-top:2px}

.form-label{display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.form-input{
  width:100%;padding:10px 13px;border:1.5px solid #e2e8f0;
  border-radius:10px;font-size:14px;color:#1e293b;outline:none;
  transition:border-color var(--tr);background:white;
}
.form-input:focus{border-color:var(--accent)}
.form-row{margin-bottom:14px}

.icon-tabs{
  display:flex;gap:3px;background:#f1f5f9;border-radius:10px;padding:3px;margin-bottom:10px;
}
.icon-tab{
  flex:1;padding:8px;border:none;background:transparent;
  border-radius:7px;cursor:pointer;font-size:13px;font-weight:500;
  color:#64748b;transition:all var(--tr);
}
.icon-tab.active{background:white;color:var(--accent);box-shadow:0 1px 4px rgba(0,0,0,.1);font-weight:600}

.image-upload-area{display:flex;gap:7px;align-items:center}
.image-url-input{flex:1}
.upload-btn{
  padding:10px 12px;border:1.5px solid #e2e8f0;border-radius:10px;
  background:white;cursor:pointer;font-size:13px;font-weight:500;
  color:#64748b;white-space:nowrap;transition:all var(--tr);
  display:flex;align-items:center;gap:5px;
}
.upload-btn:hover{border-color:var(--accent);color:var(--accent)}

.modal-footer{
  display:flex;justify-content:flex-end;gap:9px;
  margin-top:20px;padding-top:18px;border-top:1px solid #f1f5f9;
}
.btn{padding:9px 18px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all var(--tr)}
.btn-secondary{background:#f1f5f9;color:#64748b}
.btn-secondary:hover{background:#e2e8f0;color:#1e293b}
.btn-primary{background:var(--accent);color:white}
.btn-primary:hover{background:var(--accent2);transform:translateY(-1px)}
.btn-danger{background:#fef2f2;color:#ef4444}
.btn-danger:hover{background:#fee2e2}

/* â”€â”€ SETTINGS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.settings-backdrop{position:fixed;inset:0;z-index:700;background:rgba(0,0,0,.28);display:none}
.settings-backdrop.show{display:block}
.settings-panel{
  position:fixed;top:0;right:-440px;width:420px;height:100vh;
  background:white;z-index:710;overflow-y:auto;
  box-shadow:-8px 0 32px rgba(0,0,0,.15);
  transition:right .3s cubic-bezier(.4,0,.2,1);
}
.settings-panel.open{right:0}
.settings-header{
  padding:22px 24px;border-bottom:1px solid #f1f5f9;
  display:flex;justify-content:space-between;align-items:center;
  position:sticky;top:0;background:white;z-index:1;
}
.settings-header h2{font-size:17px;font-weight:700}
.settings-nav{display:flex;flex-direction:column;padding:12px;gap:2px;border-bottom:1px solid #f1f5f9}
.settings-nav-item{
  padding:10px 13px;border-radius:10px;cursor:pointer;font-size:14px;
  font-weight:500;color:#64748b;transition:all var(--tr);
  display:flex;align-items:center;gap:9px;
}
.settings-nav-item:hover{background:#f8fafc;color:#1e293b}
.settings-nav-item.active{background:#f0fdf4;color:#16a34a;font-weight:600}
.settings-section{padding:22px;display:none}
.settings-section.active{display:block}
.settings-section h3{font-size:15px;font-weight:700;margin-bottom:18px;color:#1e293b}

/* Toggle switch */
.toggle-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding:10px 0;border-bottom:1px solid #f8fafc}
.toggle-label{font-size:14px;font-weight:500;color:#1e293b}
.toggle-sub{font-size:12px;color:#94a3b8;margin-top:1px}
.switch{position:relative;width:40px;height:22px;flex-shrink:0}
.switch input{opacity:0;width:0;height:0}
.slider{
  position:absolute;inset:0;background:#cbd5e1;border-radius:22px;cursor:pointer;
  transition:background var(--tr);
}
.slider:before{
  content:'';position:absolute;width:16px;height:16px;background:white;
  border-radius:50%;left:3px;top:3px;transition:transform var(--tr);
  box-shadow:0 1px 3px rgba(0,0,0,.2);
}
.switch input:checked + .slider{background:var(--accent)}
.switch input:checked + .slider:before{transform:translateX(18px)}

.user-card{
  background:#f8fafc;border-radius:12px;padding:12px 14px;
  display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;
}
.user-name{font-size:14px;font-weight:600}
.user-meta{font-size:12px;color:#64748b}
.badge{padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600}
.badge-admin{background:#fef3c7;color:#d97706}
.badge-user{background:#f0fdf4;color:#16a34a}

.wallpaper-presets{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.wp-preset{
  aspect-ratio:16/9;border-radius:10px;cursor:pointer;overflow:hidden;
  border:3px solid transparent;transition:all var(--tr);
}
.wp-preset:hover,.wp-preset.selected{border-color:var(--accent);transform:scale(1.03)}
.wp-preset img{width:100%;height:100%;object-fit:cover}
.wp-preset.none-preset{
  background:linear-gradient(135deg,#e2e8f0,#cbd5e1);
  display:flex;align-items:center;justify-content:center;
  font-size:11px;color:#64748b;font-weight:500;
}

/* Toast */
.toast{
  position:fixed;bottom:28px;left:50%;
  transform:translateX(-50%) translateY(100px);
  background:rgba(0,0,0,.78);color:white;padding:9px 18px;
  border-radius:20px;font-size:13px;z-index:9999;
  transition:transform .28s;backdrop-filter:blur(10px);white-space:nowrap;
}
.toast.show{transform:translateX(-50%) translateY(0)}

@media(max-width:600px){
  .dash-content{padding:0 14px 20px}
  .apps-grid{gap:12px}
  .app-card{width:76px}
  .app-icon-wrap{width:60px;height:60px}
  .settings-panel{width:100%}
}
</style>
</head>
<body>

<!-- â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="dashboard">
  <div class="wp-bg" id="wp-bg"></div>
  <div class="wp-overlay"></div>
  <div class="dash-content">
    <div class="dash-header">
      <img class="dash-logo" id="dash-logo" src="" alt="logo">
      <button class="settings-btn" id="settings-open-btn" title="è®¾ç½®">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06-.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </button>
    </div>
    <div class="hero">
      <div class="hero-hostname" id="hero-hostname">EasyPanel</div>
      <div class="hero-clock" id="hero-clock"></div>
    </div>
    <div class="apps-section" id="apps-section"></div>
  </div>
</div>

<!-- â”€â”€ LOGIN OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-overlay" class="hidden">
  <div class="login-card">
    <div class="login-logo">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
        <rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/>
      </svg>
    </div>
    <div class="login-title">EasyPanel</div>
    <div class="login-sub" id="login-sub">è¯·ç™»å½•ä»¥ç»§ç»­</div>
    <div class="form-group">
      <span class="ico">ğŸ‘¤</span>
      <input type="text" id="login-username" placeholder="è´¦å·" autocomplete="username">
    </div>
    <div class="form-group">
      <span class="ico">ğŸ”’</span>
      <input type="password" id="login-password" placeholder="å¯†ç " autocomplete="current-password">
    </div>
    <p class="login-err" id="login-err">è´¦å·æˆ–å¯†ç é”™è¯¯</p>
    <button class="login-btn" onclick="doLogin()">ç™»å½•</button>
    <p class="login-footer">Powered By EasyPanel</p>
  </div>
</div>

<!-- â”€â”€ APP MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="app-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">æ·»åŠ åº”ç”¨</div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="preview-area">
      <div class="preview-icon" id="preview-icon">A</div>
      <div>
        <div class="preview-title" id="preview-title">åº”ç”¨åç§°</div>
        <div class="preview-url" id="preview-url">https://...</div>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label">å›¾æ ‡é£æ ¼</label>
      <div class="icon-tabs">
        <button class="icon-tab active" onclick="setIconType('text')">æ–‡å­—</button>
        <button class="icon-tab" onclick="setIconType('image')">å›¾ç‰‡</button>
      </div>
      <div id="icon-text-area">
        <input type="text" class="form-input" id="icon-text-input" placeholder="æ–‡å­—å†…å®¹ï¼ˆæœ€å¤š2å­—ç¬¦ï¼‰" maxlength="2" oninput="updatePreview()">
      </div>
      <div id="icon-image-area" style="display:none">
        <div class="image-upload-area">
          <input type="text" class="form-input image-url-input" id="icon-image-url" placeholder="è¾“å…¥å›¾æ ‡åœ°å€æˆ–ä¸Šä¼ " oninput="updatePreview()">
          <label class="upload-btn" for="icon-image-file">ğŸ“ æœ¬åœ°ä¸Šä¼ </label>
          <input type="file" id="icon-image-file" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
        </div>
      </div>
    </div>
    <div class="form-row">
      <label class="form-label">æ ‡é¢˜ <span style="color:#ef4444">*</span></label>
      <input type="text" class="form-input" id="app-title" placeholder="è¯·è¾“å…¥" maxlength="20" oninput="updatePreview()">
    </div>
    <div class="form-row">
      <label class="form-label">åœ°å€ <span style="color:#ef4444">*</span></label>
      <input type="text" class="form-input" id="app-url" placeholder="http(s)://" oninput="updatePreview()">
    </div>
    <div class="form-row">
      <label class="form-label">æ‰“å¼€æ–¹å¼</label>
      <select class="form-input" id="app-open-type">
        <option value="new_tab">æ–°çª—å£æ‰“å¼€</option>
        <option value="current">å½“å‰çª—å£</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" id="modal-del-btn" onclick="deleteCurrentApp()" style="display:none">åˆ é™¤</button>
      <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveApp()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- â”€â”€ RIGHT-CLICK MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item" onclick="ctxEdit()">âœ &nbsp;ç¼–è¾‘</div>
  <div class="ctx-item danger" onclick="ctxDelete()">ğŸ—‘ &nbsp;åˆ é™¤</div>
</div>

<!-- â”€â”€ SETTINGS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="settings-backdrop" id="settings-backdrop" onclick="closeSettings()"></div>
<div class="settings-panel" id="settings-panel">
  <div class="settings-header">
    <h2>è®¾ç½®</h2>
    <button class="modal-close" onclick="closeSettings()">âœ•</button>
  </div>
  <div class="settings-nav">
    <div class="settings-nav-item active" onclick="switchTab('account')">ğŸ‘¤ è´¦æˆ·ä¿¡æ¯</div>
    <div class="settings-nav-item" onclick="switchTab('panel')">ğŸ–¥ï¸ é¢æ¿è®¾ç½®</div>
    <div class="settings-nav-item" onclick="switchTab('clock')">ğŸ• æ—¶é’Ÿè®¾ç½®</div>
    <div class="settings-nav-item" onclick="switchTab('wallpaper')">ğŸ–¼ï¸ å£çº¸è®¾ç½®</div>
    <div class="settings-nav-item" onclick="switchTab('users')">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</div>
    <div class="settings-nav-item" onclick="switchTab('access')">ğŸ”“ è®¿é—®æ§åˆ¶</div>
  </div>

  <!-- è´¦æˆ· -->
  <div class="settings-section active" id="tab-account">
    <h3>è´¦æˆ·ä¿¡æ¯</h3>
    <div class="form-row"><label class="form-label">è´¦å·</label>
      <input class="form-input" id="s-username" disabled></div>
    <div class="form-row"><label class="form-label">æ˜µç§°</label>
      <input class="form-input" id="s-nickname" placeholder="è¾“å…¥æ˜µç§°"></div>
    <button class="btn btn-primary" style="width:100%;margin-bottom:16px" onclick="saveNickname()">ä¿å­˜æ˜µç§°</button>
    <h3 style="margin-top:16px">ä¿®æ”¹å¯†ç </h3>
    <div class="form-row"><label class="form-label">æ—§å¯†ç </label>
      <input type="password" class="form-input" id="s-old-pwd"></div>
    <div class="form-row"><label class="form-label">æ–°å¯†ç </label>
      <input type="password" class="form-input" id="s-new-pwd"></div>
    <button class="btn btn-primary" style="width:100%;margin-bottom:20px" onclick="changePassword()">ä¿®æ”¹å¯†ç </button>
    <div style="padding-top:16px;border-top:1px solid #f1f5f9">
      <button class="btn btn-danger" style="width:100%" onclick="doLogout()">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <!-- é¢æ¿è®¾ç½® -->
  <div class="settings-section" id="tab-panel">
    <h3>é¢æ¿è®¾ç½®</h3>
    <div class="form-row"><label class="form-label">ä¸»æœºåæ˜¾ç¤º</label>
      <input class="form-input" id="s-hostname" placeholder="EasyPanel"></div>
    <div class="form-row">
      <label class="form-label">LOGOï¼ˆURL æˆ–ä¸Šä¼ ï¼‰</label>
      <div class="image-upload-area">
        <input class="form-input image-url-input" id="s-logo-url" placeholder="https://..." oninput="previewLogo()">
        <label class="upload-btn" for="logo-file">ğŸ“</label>
        <input type="file" id="logo-file" accept="image/*" style="display:none" onchange="handleLogoUpload(this)">
      </div>
      <img id="logo-preview" style="width:52px;height:52px;border-radius:10px;margin-top:8px;object-fit:cover;display:none">
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="savePanelSettings()">ä¿å­˜</button>
  </div>

  <!-- æ—¶é’Ÿè®¾ç½® -->
  <div class="settings-section" id="tab-clock">
    <h3>æ—¶é’Ÿæ˜¾ç¤ºè®¾ç½®</h3>
    <div class="toggle-row">
      <div><div class="toggle-label">æ˜¾ç¤ºæ—¶é—´</div><div class="toggle-sub">HH:MM</div></div>
      <label class="switch"><input type="checkbox" id="clk-time" onchange="saveClockSettings()"><span class="slider"></span></label>
    </div>
    <div class="toggle-row">
      <div><div class="toggle-label">æ˜¾ç¤ºç§’</div><div class="toggle-sub">HH:MM:SS</div></div>
      <label class="switch"><input type="checkbox" id="clk-secs" onchange="saveClockSettings()"><span class="slider"></span></label>
    </div>
    <div class="toggle-row">
      <div><div class="toggle-label">æ˜¾ç¤ºæ—¥æœŸ</div><div class="toggle-sub">æœˆ-æ—¥</div></div>
      <label class="switch"><input type="checkbox" id="clk-date" onchange="saveClockSettings()"><span class="slider"></span></label>
    </div>
    <div class="toggle-row">
      <div><div class="toggle-label">æ˜¾ç¤ºæ˜ŸæœŸ</div><div class="toggle-sub">æ˜ŸæœŸä¸€ ï½ æ˜ŸæœŸæ—¥</div></div>
      <label class="switch"><input type="checkbox" id="clk-weekday" onchange="saveClockSettings()"><span class="slider"></span></label>
    </div>
    <div class="toggle-row">
      <div><div class="toggle-label">æ˜¾ç¤ºå†œå†</div><div class="toggle-sub">å¦‚ï¼šæ­£æœˆåˆä¸€</div></div>
      <label class="switch"><input type="checkbox" id="clk-lunar" onchange="saveClockSettings()"><span class="slider"></span></label>
    </div>
  </div>

  <!-- å£çº¸ -->
  <div class="settings-section" id="tab-wallpaper">
    <h3>å£çº¸è®¾ç½®</h3>
    <div class="wallpaper-presets" id="wp-presets"></div>
    <div class="form-row">
      <label class="form-label">è‡ªå®šä¹‰ URL</label>
      <div class="image-upload-area">
        <input class="form-input image-url-input" id="wp-url" placeholder="https://..." oninput="previewWp(this.value)">
        <label class="upload-btn" for="wp-file">ğŸ“</label>
        <input type="file" id="wp-file" accept="image/*" style="display:none" onchange="handleWpUpload(this)">
      </div>
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:6px" onclick="saveWallpaper()">åº”ç”¨å£çº¸</button>
  </div>

  <!-- ç”¨æˆ·ç®¡ç† -->
  <div class="settings-section" id="tab-users">
    <h3>ç”¨æˆ·ç®¡ç†</h3>
    <div id="users-list"></div>
    <div style="margin-top:18px;padding-top:18px;border-top:1px solid #f1f5f9">
      <h3 style="margin-bottom:14px">æ·»åŠ ç”¨æˆ·</h3>
      <div class="form-row"><label class="form-label">è´¦å·</label><input class="form-input" id="nu-username"></div>
      <div class="form-row"><label class="form-label">å¯†ç </label><input type="password" class="form-input" id="nu-password"></div>
      <div class="form-row"><label class="form-label">æ˜µç§°</label><input class="form-input" id="nu-nickname" placeholder="å¯é€‰"></div>
      <button class="btn btn-primary" style="width:100%" onclick="addUser()">æ·»åŠ ç”¨æˆ·</button>
    </div>
  </div>

  <!-- è®¿é—®æ§åˆ¶ -->
  <div class="settings-section" id="tab-access">
    <h3>è®¿é—®æ§åˆ¶</h3>
    <div class="toggle-row">
      <div>
        <div class="toggle-label">å…¬å¼€è®¿é—®æ¨¡å¼</div>
        <div class="toggle-sub">å¼€å¯åæ— éœ€ç™»å½•å³å¯æŸ¥çœ‹é¢æ¿ï¼Œç¼–è¾‘æ“ä½œä»éœ€ç™»å½•</div>
      </div>
      <label class="switch"><input type="checkbox" id="public-mode-toggle" onchange="setPublicMode(this.checked)"><span class="slider"></span></label>
    </div>
    <div style="margin-top:12px;padding:12px;background:#f8fafc;border-radius:10px;font-size:13px;color:#64748b;line-height:1.6">
      <b>å…¬å¼€æ¨¡å¼ï¼š</b>è®¿å®¢ç›´æ¥è¿›å…¥é¢æ¿ï¼Œç‚¹å‡»è®¾ç½®æˆ–ç¼–è¾‘å›¾æ ‡æ—¶å¼¹å‡ºç™»å½•æ¡†<br>
      <b>ç§æœ‰æ¨¡å¼ï¼š</b>è®¿é—®é¢æ¿éœ€å…ˆç™»å½•ï¼ˆé»˜è®¤ï¼‰
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ å†œå†ç®—æ³• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const lunarInfo = [
  0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,
  0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,
  0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,
  0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,
  0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,
  0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052b0,0x0a9a8,0x0e950,0x06aa0,
  0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,
  0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b6a0,0x195a6,
  0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,
  0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06aa0,0x0a6b6,0x056a0,0x02b40,0x0d9e4,
  0x0d950,0x0c954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,
  0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0f92f,
  0x0e950,0x06c40,0x0d9a6,0x0aad0,0x055b0,0x04ae4,0x0a570,0x05260,0x0f263,0x0d950
];
const tianGan = 'ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸';
const diZhi = 'å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥';
const lunarMonths = ['æ­£','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å','å†¬','è…Š'];
const lunarDays = ['åˆä¸€','åˆäºŒ','åˆä¸‰','åˆå››','åˆäº”','åˆå…­','åˆä¸ƒ','åˆå…«','åˆä¹','åˆå',
  'åä¸€','åäºŒ','åä¸‰','åå››','åäº”','åå…­','åä¸ƒ','åå…«','åä¹','äºŒå',
  'å»¿ä¸€','å»¿äºŒ','å»¿ä¸‰','å»¿å››','å»¿äº”','å»¿å…­','å»¿ä¸ƒ','å»¿å…«','å»¿ä¹','ä¸‰å'];

function getLunarDate(date) {
  try {
    // Simple lunar display using offset calculation
    const baseDate = new Date(1900, 0, 31);
    const offset = Math.floor((date - baseDate) / 86400000);
    let i, temp = 0, leap = 0, isLeap = false;
    for (i = 1900; i < 2100 && temp <= offset; i++) {
      temp += lYearDays(i);
    }
    if (temp > offset) i--;
    temp -= lYearDays(i);
    let offset2 = offset - temp;
    for (let m = 1; m < 13 && offset2 > 0; m++) {
      leap = leapMonth(i);
      if (!isLeap && m === leap + 1 && leapDays(i) > 0) {
        --m; isLeap = true; temp = leapDays(i);
      } else {
        temp = monthDays(i, m);
      }
      if (isLeap && m === leap + 1) isLeap = false;
      offset2 -= temp;
    }
    if (offset2 === 0 && leapMonth(i) === (arguments[1]||0) && isLeap) isLeap = false;
    if (offset2 < 0) { offset2 += temp; --m; }
    const lMonth = m;
    const lDay = offset2 + 1;
    return lunarMonths[lMonth-1] + 'æœˆ' + lunarDays[lDay-1];
  } catch(e) { return ''; }
}

function leapMonth(y) { return lunarInfo[y-1900] & 0xf; }
function leapDays(y) { return leapMonth(y) ? ((lunarInfo[y-1900] & 0x10000) ? 30 : 29) : 0; }
function monthDays(y, m) { return (lunarInfo[y-1900] & (0x10000>>m)) ? 30 : 29; }
function lYearDays(y) {
  let i, sum = 348;
  for (i = 0x8000; i > 0x8; i >>= 1) sum += (lunarInfo[y-1900] & i) ? 1 : 0;
  return sum + leapDays(y);
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let apps = [];
let panelInfo = {};
let clockCfg = {show_time:true,show_date:true,show_weekday:true,show_lunar:false,show_seconds:false};
let currentUser = null;  // null = not logged in
let publicMode = false;
let editingAppId = null;
let currentIconType = 'text';
let sortModeActive = false;
let ctxTargetId = null;
let loginCallback = null; // fn to call after successful login in public mode
let clockTimer = null;

const WP_PRESETS = [
  'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=1920&q=80',
  'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80',
  'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=1920&q=80',
  'https://images.unsplash.com/photo-1518895949257-7621c3c786d7?w=1920&q=80',
  'https://images.unsplash.com/photo-1540206395-68808572332f?w=1920&q=80',
];

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(url, opts={}) {
  const res = await fetch(url, {
    headers:{'Content-Type':'application/json'},
    credentials:'include', ...opts
  });
  if (!res.ok) {
    const err = await res.json().catch(()=>({}));
    throw new Error(err.error || 'Request failed');
  }
  return res.json();
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  // Always load panel info and apps (public endpoints)
  await loadPanelInfo();
  await loadApps();
  startClock();

  // Check if logged in
  const auth = await api('/api/checkauth').catch(()=>({logged_in:false}));
  if (auth.logged_in) {
    currentUser = auth;
  }

  // If not public mode and not logged in â†’ show login overlay as main gate
  if (!publicMode && !currentUser) {
    showLoginOverlay('è¯·ç™»å½•ä»¥è®¿é—®é¢æ¿', () => {
      // after login, hide overlay, done
      hideLoginOverlay();
    });
  }
}

async function loadPanelInfo() {
  try {
    panelInfo = await api('/api/panel');
    publicMode = panelInfo.public_mode || false;
    clockCfg = panelInfo.clock || clockCfg;
    document.getElementById('hero-hostname').textContent = panelInfo.hostname || 'EasyPanel';
    if (panelInfo.wallpaper) {
      document.getElementById('wp-bg').style.backgroundImage = `url(${panelInfo.wallpaper})`;
    } else {
      document.getElementById('wp-bg').style.background = 'linear-gradient(135deg,#1a3a5c 0%,#2d6a4f 100%)';
    }
    if (panelInfo.logo) {
      const el = document.getElementById('dash-logo');
      el.src = panelInfo.logo; el.style.display = 'block';
    }
  } catch(e) { console.error(e); }
}

async function loadApps() {
  try {
    apps = await api('/api/apps');
    renderApps();
  } catch(e) { console.error(e); }
}

// â”€â”€ LOGIN OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoginOverlay(subtitle, callback) {
  loginCallback = callback;
  document.getElementById('login-sub').textContent = subtitle || 'è¯·ç™»å½•';
  document.getElementById('login-err').style.display = 'none';
  document.getElementById('login-username').value = '';
  document.getElementById('login-password').value = '';
  document.getElementById('login-overlay').classList.remove('hidden');
  setTimeout(()=>document.getElementById('login-username').focus(), 100);
}

function hideLoginOverlay() {
  document.getElementById('login-overlay').classList.add('hidden');
  loginCallback = null;
}

async function doLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  document.getElementById('login-err').style.display = 'none';
  try {
    const res = await api('/api/login', {method:'POST', body:JSON.stringify({username,password})});
    currentUser = res;
    hideLoginOverlay();
    if (loginCallback) { loginCallback(); loginCallback = null; }
  } catch(e) {
    document.getElementById('login-err').style.display = 'block';
  }
}

document.getElementById('login-password').addEventListener('keydown', e=>{
  if (e.key==='Enter') doLogin();
});

async function doLogout() {
  await api('/api/logout',{method:'POST'}).catch(()=>{});
  currentUser = null;
  closeSettings();
  if (!publicMode) {
    showLoginOverlay('è¯·ç™»å½•ä»¥è®¿é—®é¢æ¿', ()=>hideLoginOverlay());
  }
  showToast('å·²é€€å‡ºç™»å½•');
}

// â”€â”€ requireAuth: for public mode, actions that need login â”€â”€â”€â”€â”€â”€â”€â”€
function requireAuth(callback) {
  if (currentUser) { callback(); return; }
  showLoginOverlay('éœ€è¦ç™»å½•æ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ', () => {
    hideLoginOverlay();
    callback();
  });
}

// Settings btn â†’ requireAuth
document.getElementById('settings-open-btn').addEventListener('click', ()=>{
  requireAuth(openSettings);
});

// â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startClock() {
  if (clockTimer) clearInterval(clockTimer);
  updateClock();
  clockTimer = setInterval(updateClock, 1000);
}

function updateClock() {
  const now = new Date();
  const parts = [];
  if (clockCfg.show_time) {
    const h = String(now.getHours()).padStart(2,'0');
    const m = String(now.getMinutes()).padStart(2,'0');
    if (clockCfg.show_seconds) {
      const s = String(now.getSeconds()).padStart(2,'0');
      parts.push(`<span>${h}:${m}:${s}</span>`);
    } else {
      parts.push(`<span>${h}:${m}</span>`);
    }
  }
  if (clockCfg.show_date) {
    parts.push(`<span class="divider">|</span><span>${now.getMonth()+1}-${now.getDate()}</span>`);
  }
  const days = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'];
  if (clockCfg.show_weekday) {
    parts.push(`<span>${days[now.getDay()]}</span>`);
  }
  if (clockCfg.show_lunar) {
    const lunar = getLunarDate(now);
    if (lunar) parts.push(`<span class="divider">|</span><span>${lunar}</span>`);
  }
  document.getElementById('hero-clock').innerHTML = parts.join('');
}

// â”€â”€ RENDER APPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderApps() {
  const section = document.getElementById('apps-section');
  section.innerHTML = '';

  const labelRow = document.createElement('div');
  labelRow.className = 'group-label-row';
  labelRow.innerHTML = `
    <div class="group-label" style="margin-bottom:0">APP</div>
    <div class="group-toolbar">
      <button class="toolbar-btn" title="æ·»åŠ åº”ç”¨" id="toolbar-add-btn">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      </button>
      <button class="toolbar-btn" title="æ’åºå›¾æ ‡" id="toolbar-sort-btn">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/>
          <rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/>
        </svg>
      </button>
    </div>`;
  section.appendChild(labelRow);

  // Sort mode bar
  const sortBar = document.createElement('div');
  sortBar.id = 'sort-mode-bar';
  sortBar.innerHTML = `<button class="sort-save-btn" onclick="exitSortMode(true)">ğŸ’¾ ä¿å­˜æ’åº</button>
    <button class="sort-save-btn" style="background:rgba(255,255,255,.6);margin-left:8px" onclick="exitSortMode(false)">âœ• å–æ¶ˆ</button>`;
  section.appendChild(sortBar);

  const grid = document.createElement('div');
  grid.className = 'apps-grid';
  grid.id = 'apps-grid';
  apps.forEach(app => grid.appendChild(createAppCard(app)));
  section.appendChild(grid);

  // Bind toolbar buttons (requireAuth for public mode)
  document.getElementById('toolbar-add-btn').onclick = () => requireAuth(openAddModal);
  document.getElementById('toolbar-sort-btn').onclick = () => requireAuth(enterSortMode);
}

function createAppCard(app) {
  const card = document.createElement('div');
  card.className = 'app-card';
  card.dataset.id = app.id;

  const title = app.title || '?';
  const fallback = title.substring(0,2);
  let iconHtml = '';
  if (app.icon_type === 'image' && app.icon_image) {
    iconHtml = `<img class="app-icon" src="${app.icon_image}" alt="${title}"
      onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
      <div class="app-icon-text" style="display:none">${fallback}</div>`;
  } else {
    const txt = (app.icon_text && app.icon_text.trim()) ? app.icon_text.trim() : fallback;
    iconHtml = `<div class="app-icon-text">${txt}</div>`;
  }

  const wrap = document.createElement('div');
  wrap.className = 'app-icon-wrap';
  wrap.innerHTML = iconHtml;

  const name = document.createElement('div');
  name.className = 'app-name';
  name.textContent = title;

  card.appendChild(wrap);
  card.appendChild(name);

  // Click â†’ open URL (only when not in sort mode)
  wrap.addEventListener('click', ()=>{
    if (sortModeActive) return;
    if (!app.url) return;
    app.open_type === 'current' ? (window.location.href = app.url) : window.open(app.url,'_blank');
  });

  // Right-click â†’ edit/delete (requireAuth)
  card.addEventListener('contextmenu', e=>{
    e.preventDefault();
    if (sortModeActive) return;
    requireAuth(()=> showCtxMenu(e.clientX, e.clientY, app.id));
  });

  // Drag for sort mode
  card.draggable = true;
  card.addEventListener('dragstart', e=>{
    if (!sortModeActive) { e.preventDefault(); return; }
    e.dataTransfer.effectAllowed = 'move';
    card.style.opacity = '.4';
    card.dataset.dragging = '1';
  });
  card.addEventListener('dragend', ()=>{
    card.style.opacity = '';
    delete card.dataset.dragging;
    document.querySelectorAll('.app-card').forEach(c=>c.classList.remove('drag-over'));
  });
  card.addEventListener('dragover', e=>{
    if (!sortModeActive) return;
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    card.classList.add('drag-over');
  });
  card.addEventListener('dragleave', ()=> card.classList.remove('drag-over'));
  card.addEventListener('drop', e=>{
    e.preventDefault();
    card.classList.remove('drag-over');
    const srcCard = document.querySelector('.app-card[data-dragging="1"]');
    if (!srcCard || srcCard === card) return;
    const srcId = srcCard.dataset.id;
    const dstId = card.dataset.id;
    reorderLocalApps(srcId, dstId);
  });

  return card;
}

function reorderLocalApps(srcId, dstId) {
  const si = apps.findIndex(a=>a.id===srcId);
  const di = apps.findIndex(a=>a.id===dstId);
  if (si<0||di<0) return;
  const [item] = apps.splice(si,1);
  apps.splice(di,0,item);
  renderApps();
  enterSortMode(); // re-enter to keep sort mode active
}

// â”€â”€ SORT MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enterSortMode() {
  sortModeActive = true;
  document.getElementById('sort-mode-bar').style.display = 'block';
  document.querySelectorAll('.app-card').forEach(c=>c.classList.add('sort-mode'));
  document.getElementById('toolbar-sort-btn').classList.add('sort-active');
}

async function exitSortMode(save) {
  sortModeActive = false;
  document.getElementById('sort-mode-bar').style.display = 'none';
  document.querySelectorAll('.app-card').forEach(c=>c.classList.remove('sort-mode'));
  if (document.getElementById('toolbar-sort-btn'))
    document.getElementById('toolbar-sort-btn').classList.remove('sort-active');
  if (save) {
    try {
      await api('/api/apps/reorder',{method:'POST',body:JSON.stringify({ids:apps.map(a=>a.id)})});
      showToast('æ’åºå·²ä¿å­˜ âœ“');
    } catch(e) { showToast('ä¿å­˜å¤±è´¥'); }
  } else {
    await loadApps(); // reload original order
  }
}

// â”€â”€ CONTEXT MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCtxMenu(x, y, id) {
  ctxTargetId = id;
  const menu = document.getElementById('ctx-menu');
  menu.classList.add('show');
  const ml=140, mh=90;
  menu.style.left = (x+ml>innerWidth ? x-ml : x)+'px';
  menu.style.top  = (y+mh>innerHeight ? y-mh : y)+'px';
}
function hideCtxMenu() {
  document.getElementById('ctx-menu').classList.remove('show');
  ctxTargetId = null;
}
function ctxEdit() { hideCtxMenu(); if(ctxTargetId) openEditModal(ctxTargetId); }
async function ctxDelete() {
  hideCtxMenu();
  if (!ctxTargetId) return;
  if (!confirm('ç¡®è®¤åˆ é™¤æ­¤åº”ç”¨ï¼Ÿ')) return;
  try {
    await api(`/api/apps/${ctxTargetId}`,{method:'DELETE'});
    await loadApps(); showToast('å·²åˆ é™¤');
  } catch(e) { showToast('åˆ é™¤å¤±è´¥'); }
}
document.addEventListener('click', hideCtxMenu);
document.addEventListener('scroll', hideCtxMenu, true);

// â”€â”€ APP MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddModal() {
  editingAppId = null;
  document.getElementById('modal-title').textContent = 'æ·»åŠ åº”ç”¨';
  document.getElementById('modal-del-btn').style.display = 'none';
  resetModal();
  document.getElementById('app-modal').classList.add('show');
}

function openEditModal(id) {
  const app = apps.find(a=>a.id===id);
  if (!app) return;
  editingAppId = id;
  document.getElementById('modal-title').textContent = 'ç¼–è¾‘åº”ç”¨';
  document.getElementById('modal-del-btn').style.display = 'block';
  setIconType(app.icon_type||'text');
  document.getElementById('icon-text-input').value = app.icon_text||'';
  document.getElementById('icon-image-url').value = app.icon_image||'';
  document.getElementById('app-title').value = app.title||'';
  document.getElementById('app-url').value = app.url||'';
  document.getElementById('app-open-type').value = app.open_type||'new_tab';
  updatePreview();
  document.getElementById('app-modal').classList.add('show');
}

function closeModal() { document.getElementById('app-modal').classList.remove('show'); }

function resetModal() {
  setIconType('text');
  ['icon-text-input','icon-image-url','app-title','app-url'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('app-open-type').value = 'new_tab';
  updatePreview();
}

function setIconType(type) {
  currentIconType = type;
  document.querySelectorAll('.icon-tab').forEach((t,i)=>{
    t.classList.toggle('active',(i===0&&type==='text')||(i===1&&type==='image'));
  });
  document.getElementById('icon-text-area').style.display = type==='text'?'block':'none';
  document.getElementById('icon-image-area').style.display = type==='image'?'block':'none';
  updatePreview();
}

function updatePreview() {
  const title = document.getElementById('app-title').value || 'åº”ç”¨åç§°';
  const url = document.getElementById('app-url').value || 'https://...';
  const iconText = document.getElementById('icon-text-input').value || title.substring(0,2);
  const iconImage = document.getElementById('icon-image-url').value;
  document.getElementById('preview-title').textContent = title;
  document.getElementById('preview-url').textContent = url;
  const iconEl = document.getElementById('preview-icon');
  if (currentIconType==='image' && iconImage) {
    iconEl.innerHTML = `<img src="${iconImage}" style="width:100%;height:100%;object-fit:cover;border-radius:11px" onerror="this.parentElement.textContent='${iconText.substring(0,2)}'">`;
  } else {
    iconEl.textContent = iconText.substring(0,2);
  }
}

async function handleImageUpload(input) {
  if (!input.files[0]) return;
  const fd = new FormData(); fd.append('image', input.files[0]);
  try {
    const res = await fetch('/api/upload',{method:'POST',body:fd,credentials:'include'});
    const data = await res.json();
    document.getElementById('icon-image-url').value = data.url;
    updatePreview();
  } catch(e) { showToast('ä¸Šä¼ å¤±è´¥'); }
}

async function saveApp() {
  const title = document.getElementById('app-title').value.trim();
  const url = document.getElementById('app-url').value.trim();
  if (!title||!url) { showToast('è¯·å¡«å†™æ ‡é¢˜å’Œåœ°å€'); return; }
  const app = {
    title, url,
    icon_type: currentIconType,
    icon_text: document.getElementById('icon-text-input').value,
    icon_image: document.getElementById('icon-image-url').value,
    open_type: document.getElementById('app-open-type').value,
  };
  try {
    if (editingAppId) {
      await api(`/api/apps/${editingAppId}`,{method:'PUT',body:JSON.stringify(app)});
    } else {
      await api('/api/apps',{method:'POST',body:JSON.stringify(app)});
    }
    closeModal(); await loadApps(); showToast('ä¿å­˜æˆåŠŸ âœ“');
  } catch(e) { showToast('ä¿å­˜å¤±è´¥: '+e.message); }
}

async function deleteCurrentApp() {
  if (!editingAppId) return;
  if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
  try {
    await api(`/api/apps/${editingAppId}`,{method:'DELETE'});
    closeModal(); await loadApps(); showToast('å·²åˆ é™¤');
  } catch(e) { showToast('åˆ é™¤å¤±è´¥'); }
}

document.getElementById('app-modal').addEventListener('click', e=>{
  if (e.target===document.getElementById('app-modal')) closeModal();
});

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openSettings() {
  // Fill current values
  if (currentUser) {
    document.getElementById('s-username').value = currentUser.username||'';
    document.getElementById('s-nickname').value = currentUser.nickname||'';
  }
  document.getElementById('s-hostname').value = panelInfo.hostname||'';
  document.getElementById('s-logo-url').value = panelInfo.logo||'';
  if (panelInfo.logo) {
    document.getElementById('logo-preview').src = panelInfo.logo;
    document.getElementById('logo-preview').style.display = 'block';
  }
  document.getElementById('wp-url').value = panelInfo.wallpaper||'';
  // Clock
  const c = clockCfg;
  document.getElementById('clk-time').checked = c.show_time!==false;
  document.getElementById('clk-secs').checked = !!c.show_seconds;
  document.getElementById('clk-date').checked = c.show_date!==false;
  document.getElementById('clk-weekday').checked = c.show_weekday!==false;
  document.getElementById('clk-lunar').checked = !!c.show_lunar;
  // Public mode
  document.getElementById('public-mode-toggle').checked = publicMode;
  // Wallpaper presets
  buildWpPresets();
  // Users
  await loadUsersTab();

  document.getElementById('settings-backdrop').classList.add('show');
  document.getElementById('settings-panel').classList.add('open');
}

function closeSettings() {
  document.getElementById('settings-backdrop').classList.remove('show');
  document.getElementById('settings-panel').classList.remove('open');
}

function switchTab(tab) {
  const tabs = ['account','panel','clock','wallpaper','users','access'];
  tabs.forEach(t=>{
    const navItems = document.querySelectorAll('.settings-nav-item');
    navItems[tabs.indexOf(t)].classList.toggle('active', t===tab);
    document.getElementById('tab-'+t).classList.toggle('active', t===tab);
  });
}

async function saveNickname() {
  const nickname = document.getElementById('s-nickname').value.trim();
  try {
    await api('/api/me/nickname',{method:'PUT',body:JSON.stringify({nickname})});
    if (currentUser) currentUser.nickname = nickname;
    showToast('æ˜µç§°å·²ä¿å­˜ âœ“');
  } catch(e) { showToast('ä¿å­˜å¤±è´¥'); }
}

async function changePassword() {
  const op = document.getElementById('s-old-pwd').value;
  const np = document.getElementById('s-new-pwd').value;
  if (!op||!np) { showToast('è¯·å¡«å†™å¯†ç '); return; }
  try {
    await api('/api/me/password',{method:'PUT',body:JSON.stringify({old_password:op,new_password:np})});
    document.getElementById('s-old-pwd').value=''; document.getElementById('s-new-pwd').value='';
    showToast('å¯†ç å·²ä¿®æ”¹ âœ“');
  } catch(e) { showToast('ä¿®æ”¹å¤±è´¥: '+e.message); }
}

async function savePanelSettings() {
  const s = {
    hostname: document.getElementById('s-hostname').value.trim(),
    logo: document.getElementById('s-logo-url').value.trim(),
    wallpaper: panelInfo.wallpaper||'',
    clock: clockCfg,
  };
  try {
    await api('/api/settings',{method:'PUT',body:JSON.stringify(s)});
    await loadPanelInfo(); showToast('è®¾ç½®å·²ä¿å­˜ âœ“');
  } catch(e) { showToast('ä¿å­˜å¤±è´¥'); }
}

function previewLogo() {
  const url = document.getElementById('s-logo-url').value;
  if (url) { document.getElementById('logo-preview').src=url; document.getElementById('logo-preview').style.display='block'; }
}

async function handleLogoUpload(input) {
  if (!input.files[0]) return;
  const fd = new FormData(); fd.append('logo',input.files[0]);
  try {
    const res = await fetch('/api/upload/logo',{method:'POST',body:fd,credentials:'include'});
    const data = await res.json();
    document.getElementById('s-logo-url').value = data.url;
    document.getElementById('logo-preview').src = data.url;
    document.getElementById('logo-preview').style.display = 'block';
    showToast('ä¸Šä¼ æˆåŠŸ');
  } catch(e) { showToast('ä¸Šä¼ å¤±è´¥'); }
}

async function saveClockSettings() {
  clockCfg = {
    show_time: document.getElementById('clk-time').checked,
    show_seconds: document.getElementById('clk-secs').checked,
    show_date: document.getElementById('clk-date').checked,
    show_weekday: document.getElementById('clk-weekday').checked,
    show_lunar: document.getElementById('clk-lunar').checked,
  };
  const s = { ...panelInfo, clock: clockCfg };
  try {
    await api('/api/settings',{method:'PUT',body:JSON.stringify(s)});
    updateClock();
  } catch(e) { console.error(e); }
}

// Wallpaper
function buildWpPresets() {
  const c = document.getElementById('wp-presets');
  c.innerHTML = `<div class="wp-preset none-preset ${!panelInfo.wallpaper?'selected':''}" onclick="selectWp('')">æ— å£çº¸</div>`;
  WP_PRESETS.forEach(url=>{
    const d = document.createElement('div');
    d.className = 'wp-preset'+(panelInfo.wallpaper===url?' selected':'');
    d.onclick = ()=>selectWp(url);
    d.innerHTML = `<img src="${url}" loading="lazy">`;
    c.appendChild(d);
  });
}

function selectWp(url) {
  document.getElementById('wp-url').value = url;
  previewWp(url);
  document.querySelectorAll('.wp-preset').forEach(el=>el.classList.remove('selected'));
  if (!url) document.querySelector('.none-preset').classList.add('selected');
}

function previewWp(url) {
  document.getElementById('wp-bg').style.backgroundImage = url ? `url(${url})` : '';
  if (!url) document.getElementById('wp-bg').style.background = 'linear-gradient(135deg,#1a3a5c 0%,#2d6a4f 100%)';
}

async function handleWpUpload(input) {
  if (!input.files[0]) return;
  const fd = new FormData(); fd.append('wallpaper',input.files[0]);
  try {
    const res = await fetch('/api/upload/wallpaper',{method:'POST',body:fd,credentials:'include'});
    const data = await res.json();
    document.getElementById('wp-url').value = data.url;
    previewWp(data.url);
    showToast('ä¸Šä¼ æˆåŠŸ');
  } catch(e) { showToast('ä¸Šä¼ å¤±è´¥'); }
}

async function saveWallpaper() {
  const url = document.getElementById('wp-url').value.trim();
  const s = { hostname: panelInfo.hostname, logo: panelInfo.logo, wallpaper: url, clock: clockCfg };
  try {
    await api('/api/settings',{method:'PUT',body:JSON.stringify(s)});
    panelInfo.wallpaper = url; previewWp(url);
    showToast('å£çº¸å·²ä¿å­˜ âœ“');
  } catch(e) { showToast('ä¿å­˜å¤±è´¥'); }
}

// Users
async function loadUsersTab() {
  try {
    const users = await api('/api/users');
    document.getElementById('users-list').innerHTML = users.map(u=>`
      <div class="user-card">
        <div>
          <div class="user-name">${u.nickname||u.username}</div>
          <div class="user-meta">@${u.username}</div>
        </div>
        <div style="display:flex;align-items:center;gap:7px">
          <span class="badge ${u.is_admin?'badge-admin':'badge-user'}">${u.is_admin?'ç®¡ç†å‘˜':'ç”¨æˆ·'}</span>
          ${u.username!==currentUser?.username?`<button class="btn btn-danger" style="padding:4px 10px;font-size:12px" onclick="removeUser('${u.username}')">åˆ é™¤</button>`:''}
        </div>
      </div>`).join('');
  } catch(e) { console.error(e); }
}

async function addUser() {
  const username = document.getElementById('nu-username').value.trim();
  const password = document.getElementById('nu-password').value;
  const nickname = document.getElementById('nu-nickname').value.trim();
  if (!username||!password) { showToast('è¯·å¡«å†™è´¦å·å’Œå¯†ç '); return; }
  try {
    await api('/api/users',{method:'POST',body:JSON.stringify({username,password,nickname})});
    document.getElementById('nu-username').value='';
    document.getElementById('nu-password').value='';
    document.getElementById('nu-nickname').value='';
    await loadUsersTab(); showToast('ç”¨æˆ·å·²æ·»åŠ  âœ“');
  } catch(e) { showToast('æ·»åŠ å¤±è´¥: '+e.message); }
}

async function removeUser(username) {
  if (!confirm(`ç¡®è®¤åˆ é™¤ç”¨æˆ· ${username}ï¼Ÿ`)) return;
  try {
    await api(`/api/users/${username}`,{method:'DELETE'});
    await loadUsersTab(); showToast('å·²åˆ é™¤');
  } catch(e) { showToast('åˆ é™¤å¤±è´¥'); }
}

// Public mode
async function setPublicMode(val) {
  try {
    await api('/api/publicmode',{method:'PUT',body:JSON.stringify({public_mode:val})});
    publicMode = val;
    showToast(val?'å·²å¼€å¯å…¬å¼€è®¿é—® âœ“':'å·²åˆ‡æ¢ä¸ºç§æœ‰æ¨¡å¼ âœ“');
  } catch(e) { showToast('è®¾ç½®å¤±è´¥'); document.getElementById('public-mode-toggle').checked = !val; }
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>el.classList.remove('show'), 2500);
}

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>

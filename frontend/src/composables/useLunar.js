const LD=[0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5b0,0x14573,0x052b0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b6a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06aa0,0x0a6b6,0x056a0,0x02b40,0x0d9e4,0x0d950,0x0c954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0f92f,0x0e950,0x06c40,0x0d9a6,0x0aad0,0x055b0,0x04ae4,0x0a570,0x05260,0x0f263,0x0d950]
const LM=['正','二','三','四','五','六','七','八','九','十','冬','腊']
const LD2=['初一','初二','初三','初四','初五','初六','初七','初八','初九','初十','十一','十二','十三','十四','十五','十六','十七','十八','十九','二十','廿一','廿二','廿三','廿四','廿五','廿六','廿七','廿八','廿九','三十']
const lMon=y=>LD[y-1900]&0xf
const lDays=y=>lMon(y)?((LD[y-1900]&0x10000)?30:29):0
const mDays=(y,m)=>(LD[y-1900]&(0x10000>>m))?30:29
const lyDays=y=>{let i,s=348;for(i=0x8000;i>0x8;i>>=1)s+=(LD[y-1900]&i)?1:0;return s+lDays(y)}

export function getLunar(date) {
  try {
    const base = new Date(1900,0,31)
    let off = Math.round((date-base)/86400000), y, temp=0
    for(y=1900; y<2101&&temp<=off; y++) temp+=lyDays(y)
    if(temp>off) y--
    off -= (temp-lyDays(y))
    let m, isL=false, lm=lMon(y)
    for(m=1; m<=12&&off>0; m++){
      let d
      if(!isL&&m==lm+1&&lDays(y)>0){--m;isL=true;d=lDays(y)}
      else d=mDays(y,m)
      if(isL&&m==lm+1) isL=false
      off-=d
    }
    if(off==0&&lm==m-1&&lDays(y)>0){if(isL)isL=false;else{isL=true;--m}}
    if(off<0){off+=mDays(y,m-1);--m}
    return LM[m-1]+'月'+LD2[off]
  } catch(e){ return '' }
}
